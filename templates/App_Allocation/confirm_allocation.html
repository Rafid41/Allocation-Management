{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title_block %} Confirm Allocation {% endblock %}

{% block body_block %}
<div class="container mt-4">
    <h2>Confirm Allocation</h2>

    <form method="GET" action="{% url 'App_Allocation:confirm_allocation_page' %}" class="row g-3">
        <div class="col-md-6">
            <input type="text" name="query" id="searchQuery" class="form-control"
                   placeholder="Search by Allocation No..." value="{{ query }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>

    <hr>

    <h4>Search Results</h4>

    <div id="printableArea" class="table-responsive">
        <h3 class="text-center">Allocation Details</h3>
        <br>
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Allocation No</th>
                    <th>Package ID</th>
                    <th>Item Name</th>
                    <th>Warehouse</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody id="allocationTableBody">
                {% for allocation in allocations %}
                <tr>
                    <td>{{ allocation.allocation_no.allocation_no }}</td>
                    <td>{{ allocation.package.packageId }}</td>
                    <td>{{ allocation.item.name }}</td>
                    <td>{{ allocation.warehouse }}</td>
                    <td>{{ allocation.quantity }}</td>
                    <td>{{ allocation.price }}</td>
                    <td>{{ allocation.created_at }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-danger">No data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-danger" id="deleteAllocationBtn" data-toggle="modal" data-target="#deleteModal"
                {% if not allocations %}disabled{% endif %}>Delete Allocation</button>

        <button class="btn btn-success" id="confirmBtn" data-toggle="modal" data-target="#confirmModal"
                {% if not allocations %}disabled{% endif %}>Confirm Allocation</button>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this allocation?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Allocation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Allocation</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                Are you sure you want to confirm this allocation?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAllocation">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("confirmDelete").addEventListener("click", function() {
        let allocationNo = "{{ query }}"; 
        console.log("Deleting Allocation No:", allocationNo); // Debugging
    
        fetch(`/allocation/delete-allocation/${allocationNo}/`, {
            method: "DELETE",
            headers: { 
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            if (!data.error) location.reload();
        })
        .catch(error => console.error("Error:", error));
    });
    
    

    document.getElementById("confirmAllocation").addEventListener("click", function() {
        let allocationNo = "{{ query }}";
        fetch("{% url 'App_Allocation:confirm_allocation' %}", {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            body: new URLSearchParams({ "allocation_no": allocationNo })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert(data.message);
                location.reload();
            }
        });
    });
</script>

<style>
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}
