{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title_block %} Allocate to PBS {% endblock %}

{% block body_block %}
<div class="container mt-4">
    <h2 class="text-center mb-4"><i class="fas fa-box"></i> Allocate to PBS</h2>

    {{ default_messagebox }}

    <form id="allocationForm" method="post" class="card p-4 shadow-lg">
        {% csrf_token %}

        <div class="mb-3">
            <label for="allocation_no" class="form-label"><i class="fas fa-hashtag"></i> Allocation No:</label>
            <input type="text" id="allocation_no" name="allocation_no" class="form-control" required>
            <span id="allocation_error" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label for="pbs" class="form-label"><i class="fas fa-building"></i> PBS:</label>
            <select id="pbs" name="pbs" class="form-select">
                <option value="">Select PBS</option>
                {% for pbs in pbss %}
                <option value="{{ pbs.id }}">{{ pbs.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="package" class="form-label"><i class="fas fa-box"></i> Package:</label>
            <select id="package" name="package" class="form-select">
                <option value="">Select Package</option>
                {% if first_package %}
                <option value="{{ first_package.id }}" selected>{{ first_package.packageId }}</option>
                {% endif %}
            </select>
        </div>

        <div class="mb-3">
            <label for="item" class="form-label"><i class="fas fa-cube"></i> Item:</label>
            <select id="item" name="item" class="form-select">
                <option value="">Select Item</option>
                {% if first_item %}
                <option value="{{ first_item.id }}" selected>{{ first_item.name }}</option>
                {% endif %}
            </select>
        </div>

        <div class="mb-3">
            <label for="warehouse" class="form-label"><i class="fas fa-warehouse"></i> Warehouse:</label>
            <select id="warehouse" name="warehouse" class="form-select">
                <option value="">Select Warehouse</option>
                {% if first_warehouse %}
                <option value="{{ first_warehouse }}" selected>{{ first_warehouse }}</option>
                {% endif %}
            </select>
        </div>

        <div class="mb-3">
            <label for="quantity" class="form-label"><i class="fas fa-sort-numeric-up"></i> Quantity:</label>
            <input type="number" id="quantity" name="quantity" class="form-control" required>
            <span id="quantity_error" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label for="price" class="form-label"><i class="fas fa-dollar-sign"></i> Price:</label>
            <input type="text" id="price" name="price" class="form-control" readonly>
        </div>

        <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-save"></i> Submit
        </button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let packageDropdown = document.getElementById("package");
    let itemDropdown = document.getElementById("item");
    let warehouseDropdown = document.getElementById("warehouse");

    document.getElementById("pbs").addEventListener("change", function() {
        let pbs_id = this.value;
        packageDropdown.innerHTML = '<option value="">Select Package</option>';

        if (pbs_id) {
            fetch(`/get_packages/?pbs_id=${pbs_id}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(pkg => {
                        packageDropdown.innerHTML += `<option value="${pkg.id}">${pkg.packageId}</option>`;
                    });
                });
        }
    });

    packageDropdown.addEventListener("change", function() {
        let package_id = this.value;
        itemDropdown.innerHTML = '<option value="">Select Item</option>';

        if (package_id) {
            fetch(`/get_items_by_package/?package_id=${package_id}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        itemDropdown.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                    });
                });
        }
    });

    itemDropdown.addEventListener("change", function() {
        let package_id = packageDropdown.value;
        let item_name = this.options[this.selectedIndex].text;
        warehouseDropdown.innerHTML = '<option value="">Select Warehouse</option>';

        if (package_id && item_name) {
            fetch(`/get_warehouses_by_item/?package_id=${package_id}&item_name=${item_name}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(wh => {
                        warehouseDropdown.innerHTML += `<option value="${wh.warehouse}">${wh.warehouse}</option>`;
                    });
                });
        }
    });

    warehouseDropdown.addEventListener("change", function() {
        let item_id = itemDropdown.value;
        let warehouse = this.value;

        if (item_id && warehouse) {
            fetch(`/get_quantity_and_price/?item_id=${item_id}&warehouse=${warehouse}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("quantity").setAttribute("max", data.max_quantity);
                    document.getElementById("price").value = data.price;
                });
        }
    });

    document.getElementById("quantity").addEventListener("input", function() {
        let max = parseInt(this.getAttribute("max"));
        let value = parseInt(this.value);
        document.getElementById("quantity_error").textContent =
            value > max ? "Quantity exceeds current limit" : "";
    });
});
</script>
{% endblock %}
