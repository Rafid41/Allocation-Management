{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title_block %} Temporary Allocation {% endblock %}

{% comment %} 
#####################################################################
### VVI: This now shows Temporay_Allocation, not Final_Allocation ###
#####################################################################
{% endcomment %}

{% block body_block %}
<a href="{% url 'App_Allocation:allocation_page' %}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Back
</a>
<center><h1><b>Allocations Pending Confirmation</b></h1></center>
<div class="container mt-4">
    <h2>Search Allocations</h2>

    <form method="GET" id="dynamicSearchForm" class="mb-4">
        <div id="filterRowsContainer">
            <!-- Initial filter row will be added here by JavaScript -->
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                <button type="button" class="btn btn-secondary me-2" onclick="printResults()">Print</button>
            </div>
        </div>
    </form>

    <hr>

    <h4>Search Results</h4>

    <div id="printableArea" class="table-responsive">
        <br>
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Allocation No</th>
                    <th>PBS</th>
                    <th>Package</th>
                    <th>Item</th>
                    <th>Warehouse</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Allocation date</th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                    <tr>
                        <td>{{ item.allocation_no.allocation_no }}</td>
                        <td>{{ item.pbs }}</td>
                        <td>{{ item.package.packageId }}</td>
                        <td>{{ item.item.name }}</td>
                        <td>{{ item.warehouse }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.price }}</td>
                        <td>{{ item.created_at }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<style>
    /* Improve table readability */
    .table {
        font-size: 14px;
        text-align: center;
    }

    /* Fixed table header */
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1020;
    }

    /* Make table header stand out */
    .table-dark th {
        background-color: #343a40 !important;
        color: white !important;
    }

    /* Improve spacing and border visibility */
    .table-bordered th, .table-bordered td {
        border: 1px solid #ddd !important;
        padding: 10px;
    }

    /* Hover effect for better interaction */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Hide unnecessary elements when printing */
    @media print {
        body * { visibility: hidden; }
        #printableArea, #printableArea * { visibility: visible; }
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        @page {
            size: A4;
            margin: 0.5in;
        }
    }
</style>

<script>
    const ALL_FILTER_OPTIONS = [
      { value: "no_condition", text: "No Condition", type: "none" },
      { value: "allocation_no", text: "Allocation No", type: "text" },
      { value: "pbs", text: "PBS", type: "text" },
      { value: "package", text: "Package", type: "text" },
      { value: "item", text: "Item", type: "text" },
      { value: "warehouse", text: "Warehouse", type: "warehouse_dropdown" },
    ];

    // Build Warehouse Choices from Django context
    const WAREHOUSE_CHOICES = [
        {% for w in unique_warehouses %}
            "{{ w|escapejs }}",
        {% endfor %}
    ];

    let filterRowCount = 0;
    const maxFilterRows = 9;
    let suppressAutoAdd = false;
    let lastRowManuallyCreated = false;

    function getSelectedFilterValues() {
      const selected = [];
      document.querySelectorAll('.filter-select').forEach(sel => {
        if (sel.value !== "no_condition") selected.push(sel.value);
      });
      return selected;
    }

    function updateAvailableFilters() {
      const selected = getSelectedFilterValues();
      document.querySelectorAll('.filter-select').forEach(sel => {
        const curVal = sel.value;
        sel.innerHTML = "";
        ALL_FILTER_OPTIONS.forEach(opt => {
          if (opt.value === "no_condition" || opt.value === curVal || !selected.includes(opt.value)) {
            const o = document.createElement("option");
            o.value = opt.value;
            o.textContent = opt.text;
            sel.appendChild(o);
          }
        });
        sel.value = curVal;
      });
    }

    function updateFilterRow(select) {
      const row = select.closest(".filter-row");
      const type = select.value;
      const input = row.querySelector(".input-container");
      input.innerHTML = "";
      const opt = ALL_FILTER_OPTIONS.find(o => o.value === type);
      const idx = row.dataset.filterIndex;

      if (opt && opt.type === "text") {
        input.innerHTML = `<input type="text" name="filter_value_${idx}" class="form-control" placeholder="${opt.text}">`;
      } else if (opt && opt.type === "warehouse_dropdown") {
        let opts = `<option value="">Select Warehouse</option>`;
        WAREHOUSE_CHOICES.forEach(w => { opts += `<option value="${w}">${w}</option>`; });
        input.innerHTML = `<select name="filter_value_${idx}" class="form-select">${opts}</select>`;
      }

      updateAvailableFilters();

      const lastRow = document.querySelector(".filter-row:last-child");
      const prevVal = select.dataset.prevValue ?? "no_condition";

      if (
        !suppressAutoAdd &&
        lastRow === row &&
        type !== "no_condition" &&
        prevVal === "no_condition" &&
        filterRowCount < maxFilterRows
      ) {
        addFilterRow();
      }

      select.dataset.prevValue = type;
      updateAddRemoveButtonVisibility();
    }

    function addFilterRow(initial = "no_condition", val = "") {
      if (filterRowCount >= maxFilterRows) return;
      filterRowCount++;
      const idx = filterRowCount;
      const cont = document.getElementById("filterRowsContainer");

      const row = document.createElement("div");
      row.classList.add("row", "g-3", "mb-3", "filter-row");
      row.dataset.filterIndex = idx;
      row.innerHTML = `
        <div class="col-md-4">
          <select name="filter_type_${idx}" class="form-select filter-select"></select>
        </div>
        <div class="col-md-6 input-container"></div>
        <div class="col-md-2 d-flex justify-content-end">
          <button type="button" class="btn btn-danger remove-filter-row me-1" onclick="removeFilterRow(this)">
            <i class="fa fa-times"></i>
          </button>
          <button type="button" class="btn btn-info add-filter-row-btn" style="display:none;">
            <i class="fa fa-plus"></i> Add
          </button>
        </div>
      `;
      cont.appendChild(row);

      const select = row.querySelector(".filter-select");
      updateAvailableFilters();
      select.value = initial;
      select.addEventListener("focus", () => select.dataset.prevValue = select.value);
      select.addEventListener("pointerdown", () => select.dataset.prevValue = select.value);
      select.addEventListener("change", () => updateFilterRow(select));
      updateFilterRow(select);

      if (val) {
        const input = row.querySelector(`[name="filter_value_${idx}"]`);
        if (input) input.value = val;
      }

      row.querySelector(".add-filter-row-btn").addEventListener("click", () => addFilterRow());
      updateAddRemoveButtonVisibility();
    }

    function removeFilterRow(btn) {
      const row = btn.closest(".filter-row");
      const all = Array.from(document.querySelectorAll(".filter-row"));
      const isLast = all.length && all[all.length - 1] === row;
      row.remove();
      filterRowCount = document.querySelectorAll(".filter-row").length;

      lastRowManuallyCreated = isLast;
      updateAvailableFilters();
      updateAddRemoveButtonVisibility();
    }

    function updateAddRemoveButtonVisibility() {
      const rows = document.querySelectorAll(".filter-row");
      rows.forEach((row, i) => {
        const rm = row.querySelector(".remove-filter-row");
        const add = row.querySelector(".add-filter-row-btn");
        const sel = row.querySelector(".filter-select");

        rm.style.display = (rows.length > 1) ? "inline-block" : "none";
        add.style.display = "none";

        if (i === rows.length - 1) {
          if (lastRowManuallyCreated) {
            add.style.display = (filterRowCount < maxFilterRows) ? "inline-block" : "none";
          } else if (sel.value === "no_condition" && filterRowCount < maxFilterRows) {
            add.style.display = "inline-block";
          }
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      suppressAutoAdd = true;
      const urlParams = new URLSearchParams(window.location.search);
      const existing = [];
      for (let i = 1; i <= maxFilterRows; i++) {
        const ft = urlParams.get(`filter_type_${i}`);
        const fv = urlParams.get(`filter_value_${i}`);
        if (ft && ft !== "no_condition") existing.push({ type: ft, value: fv || "" });
      }

      if (existing.length) {
        existing.forEach(f => addFilterRow(f.type, f.value));
        if (filterRowCount < maxFilterRows) addFilterRow();
      } else {
        addFilterRow();
      }

      document.querySelectorAll(".filter-select").forEach(sel => sel.dataset.prevValue = sel.value);
      suppressAutoAdd = false;
      updateAddRemoveButtonVisibility();
      updateAvailableFilters();
    });

    function printResults() {
        window.print();
    }
</script>
{% endblock %}
