{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title_block %} History {% endblock %}

{% block body_block %}
<a href="{% url 'App_Home:home_page' %}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Back
</a>

<div class="container mt-4">
    <h2 class="text-center mb-3">History</h2>

    <form method="GET" class="mb-4" id="dynamicSearchForm">
        <div id="filterRowsContainer">
            <!-- Initial filter row will be added here by JavaScript -->
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                <button type="button" class="btn btn-secondary" onclick="printResults()">Print</button>
            </div>
        </div>
    </form>

    <!-- Printable Table -->
    <div id="printableArea" class="table-responsive">
        <table class="table table-bordered table-striped table-hover text-center">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Allocation No</th>
                    <th>PBS</th>
                    <th>Package</th>
                    <th>Item</th>
                    <th>Unit</th>
                    <th>Warehouse</th>
                    <th>Quantity</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th>
                        CS&M<br>
                        <span style="font-size: 0.75em; font-style: italic;">(dd/mm/yyyy)</span>
                    </th>
                    <th>
                        Carry from Warehouse<br>
                        <span style="font-size: 0.75em; font-style: italic;">(dd/mm/yyyy)</span>
                    </th>
                    <th>
                        Comments<br>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                        <tr class="{% if item.remarks_status == 'Deleted' or item.status == 'Cancelled' %}table-danger{% endif %}">
                            <td>{{ item.allocation_no }}</td>
                            <td>{{ item.pbs }}</td>
                            <td>{{ item.package }}</td>
                            <td>{{ item.item }}</td>
                            <td>{{ item.unit_of_item }}</td>
                            <td>{{ item.warehouse }}</td>
                            <td>{{ item.quantity }}</td>
                            <td class="{% if item.status == 'Allocated' %}text-success{% elif item.status == 'Cancelled' %}text-danger{% elif item.status == 'Modified' %}text-primary{% endif %}">
                                <strong>{{ item.status }}</strong>
                            </td>
                            <td>{{ item.remarks|safe }}</td>

                         
                            <!-- CS&M -->
                            <td class="date-cell">
                                {% if item.CS_and_M == "N/A" %}
                                    <span class="text-danger"><b>N/A</b></span><br>
                                {% elif item.CS_and_M %}
                                    {% with day=item.CS_and_M|slice:"8:10" month=item.CS_and_M|slice:"5:7" year=item.CS_and_M|slice:"0:4" %}
                                            {{ day }}/{{ month }}/{{ year }}
                                    {% endwith %}
                                    <br>
                                {% endif %}

                                {% if can_edit_cs and item.status != 'Cancelled' and item.remarks_status != 'Deleted' %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn"
                                            onclick="showInput('{{ item.id }}', 'cs')">Update</button>
                                    <button class="btn btn-sm btn-outline-danger mt-1 update-btn"
                                            data-toggle="modal" data-target="#resetModal"
                                            onclick="setResetTarget('{{ item.id }}', 'cs')">Reset</button>

                                    <div id="input_cs_{{ item.id }}" style="display: none;" class="mt-1">
                                        <input type="date" id="date_cs_{{ item.id }}" class="form-control form-control-sm"
                                            {% if item.CS_and_M and item.CS_and_M != "N/A" %}
                                                value="{{ item.CS_and_M}}"
                                            {% endif %}>
                                        <button class="btn btn-sm btn-success mt-1"
                                                onclick="submitDate('{{ item.id }}', 'cs')">Save</button>
                                    </div>
                                {% endif %}
                            </td>

                            <!-- Carry From Warehouse -->
                            <td class="date-cell">
                                {% if item.carry_from_warehouse == "N/A" %}
                                    <span class="text-danger"><b>N/A</b></span><br>
                                {% elif item.carry_from_warehouse %}
                                    {% with day=item.carry_from_warehouse|slice:"8:10" month=item.carry_from_warehouse|slice:"5:7" year=item.carry_from_warehouse|slice:"0:4" %}
                                        {{ day }}/{{ month }}/{{ year }}
                                    {% endwith %}<br>
                                {% endif %}

                                {% if can_edit_carry and item.status != 'Cancelled' and item.remarks_status != 'Deleted' %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn"
                                            onclick="showInput('{{ item.id }}', 'carry')">Update</button>
                                    <button class="btn btn-sm btn-outline-danger mt-1 update-btn"
                                            data-toggle="modal" data-target="#resetModal"
                                            onclick="setResetTarget('{{ item.id }}', 'carry')">Reset</button>

                                    <div id="input_carry_{{ item.id }}" style="display: none;" class="mt-1">
                                        <input type="date" id="date_carry_{{ item.id }}" class="form-control form-control-sm"
                                               {% if item.carry_from_warehouse and item.carry_from_warehouse != "N/A" %}
                                                   value="{{ item.carry_from_warehouse }}"
                                               {% endif %}>
                                        <button class="btn btn-sm btn-success mt-1"
                                                onclick="submitDate('{{ item.id }}', 'carry')">Save</button>
                                    </div>
                                {% endif %}
                            </td>

                            <!-- Comments -->
                            <td class="comments-cell text-start">
                                {% if item.comments %}
                                    {{ item.comments|linebreaksbr }}<br>
                                {% endif %}

                                {% if can_edit_comments %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn" onclick="showCommentInput('{{ item.id }}')">Update</button>
                                    <div id="input_comments_{{ item.id }}" style="display: none;" class="mt-1">
                                        <textarea id="text_comments_{{ item.id }}" class="form-control form-control-sm" rows="3">{{ item.comments|default_if_none:"" }}</textarea>
                                        <button class="btn btn-sm btn-success mt-1" onclick="submitComment('{{ item.id }}')">Save</button>
                                    </div>
                                {% endif %}
                            </td>


                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" role="dialog" aria-labelledby="resetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg rounded">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="resetModalLabel">
          <i class="fa fa-exclamation-triangle"></i> Confirm Reset
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to reset this date? <b>This action cannot be undone.</b>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn">
          <i class="fa fa-check"></i> Yes, Reset
        </button>
      </div>
    </div>
  </div>
</div>

<style>
    .date-cell button.update-btn { display: none; }
    .date-cell:hover button.update-btn { display: inline-block; }

    .comments-cell button.update-btn {
        display: none;
    }
    .comments-cell:hover button.update-btn {
        display: inline-block;
    }

    @media print {
        body * { visibility: hidden; }
        #printableArea, #printableArea * { visibility: visible; }
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
</style>
<script>
const ALL_FILTER_OPTIONS = [
  { value: "no_condition", text: "No Condition", type: "none" },
  { value: "allocation_no", text: "Allocation No", type: "text" },
  { value: "pbs", text: "PBS", type: "text" },
  { value: "package", text: "Package", type: "text" },
  { value: "item", text: "Item", type: "text" },
  { value: "warehouse", text: "Warehouse", type: "text" },
  { value: "status", text: "Status", type: "status_dropdown" },
  { value: "cs_and_m_date", text: "CS&M Date", type: "date" },
  { value: "carry_from_warehouse_date", text: "Carry from Warehouse Date", type: "date" },
];

const STATUS_CHOICES = JSON.parse('{{ status_choices_json|escapejs }}');
let filterRowCount = 0;
const maxFilterRows = 9;
let suppressAutoAdd = false;

// Tracks whether the current last row was created manually (after deletion)
let lastRowManuallyCreated = false;

function getSelectedFilterValues() {
  const selected = [];
  document.querySelectorAll('.filter-select').forEach(sel => {
    if (sel.value !== "no_condition") selected.push(sel.value);
  });
  return selected;
}

function updateAvailableFilters() {
  const selected = getSelectedFilterValues();
  document.querySelectorAll('.filter-select').forEach(sel => {
    const curVal = sel.value;
    sel.innerHTML = "";
    ALL_FILTER_OPTIONS.forEach(opt => {
      if (opt.value === "no_condition" || opt.value === curVal || !selected.includes(opt.value)) {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.text;
        sel.appendChild(o);
      }
    });
    sel.value = curVal;
  });
}

function updateFilterRow(select) {
  const row = select.closest(".filter-row");
  const type = select.value;
  const input = row.querySelector(".input-container");
  input.innerHTML = "";
  const opt = ALL_FILTER_OPTIONS.find(o => o.value === type);
  const idx = row.dataset.filterIndex;

  if (opt && opt.type === "text") {
    input.innerHTML = `<input type="text" name="filter_value_${idx}" class="form-control" placeholder="${opt.text}">`;
  } else if (opt && opt.type === "date") {
    input.innerHTML = `
      <input type="date" name="filter_value_${idx}" class="form-control mb-2">
      <select name="date_status_${idx}" class="form-select">
        <option value="all">Show All Data</option>
        <option value="empty">Show Empty Cells</option>
      </select>
    `;
  } else if (opt && opt.type === "status_dropdown") {
    let opts = "";
    STATUS_CHOICES.forEach(c => { opts += `<option value="${c[0]}">${c[1]}</option>`; });
    input.innerHTML = `<select name="filter_value_${idx}" class="form-select">${opts}</select>`;
  }

  updateAvailableFilters();

  const lastRow = document.querySelector(".filter-row:last-child");
  const prevVal = select.dataset.prevValue ?? "no_condition";

  // Only auto-add when last row changed from no_condition -> something
  if (
    !suppressAutoAdd &&
    lastRow === row &&
    type !== "no_condition" &&
    prevVal === "no_condition" &&
    filterRowCount < maxFilterRows
  ) {
    addFilterRow();
  }

  select.dataset.prevValue = type;
  updateAddRemoveButtonVisibility();
}

function addFilterRow(initial = "no_condition", val = "") {
  if (filterRowCount >= maxFilterRows) return;
  filterRowCount++;
  const idx = filterRowCount;
  const cont = document.getElementById("filterRowsContainer");

  const row = document.createElement("div");
  row.classList.add("row", "g-3", "mb-3", "filter-row");
  row.dataset.filterIndex = idx;
  row.innerHTML = `
    <div class="col-md-4">
      <select name="filter_type_${idx}" class="form-select filter-select"></select>
    </div>
    <div class="col-md-6 input-container"></div>
    <div class="col-md-2 d-flex justify-content-end">
      <button type="button" class="btn btn-danger remove-filter-row me-1" onclick="removeFilterRow(this)">
        <i class="fa fa-times"></i>
      </button>
      <button type="button" class="btn btn-info add-filter-row-btn" style="display:none;">
        <i class="fa fa-plus"></i> Add
      </button>
    </div>
  `;
  cont.appendChild(row);

  const select = row.querySelector(".filter-select");
  updateAvailableFilters();
  select.value = initial;
  select.addEventListener("focus", () => select.dataset.prevValue = select.value);
  select.addEventListener("pointerdown", () => select.dataset.prevValue = select.value);
  select.addEventListener("change", () => updateFilterRow(select));
  updateFilterRow(select);

  if (val) {
    const input = row.querySelector(`[name="filter_value_${idx}"]`);
    if (input) input.value = val;
  }

  row.querySelector(".add-filter-row-btn").addEventListener("click", () => addFilterRow());
  updateAddRemoveButtonVisibility();
}

function removeFilterRow(btn) {
  const row = btn.closest(".filter-row");
  const all = Array.from(document.querySelectorAll(".filter-row"));
  const isLast = all.length && all[all.length - 1] === row;
  row.remove();
  filterRowCount = document.querySelectorAll(".filter-row").length;

  // If last was deleted â†’ next last gets manual Add visibility
  lastRowManuallyCreated = isLast;
  updateAvailableFilters();
  updateAddRemoveButtonVisibility();
}

function updateAddRemoveButtonVisibility() {
  const rows = document.querySelectorAll(".filter-row");
  rows.forEach((row, i) => {
    const rm = row.querySelector(".remove-filter-row");
    const add = row.querySelector(".add-filter-row-btn");
    const sel = row.querySelector(".filter-select");

    rm.style.display = (rows.length > 1) ? "inline-block" : "none";
    add.style.display = "none";

    // Show add button logic
    if (i === rows.length - 1) {
      if (lastRowManuallyCreated) {
        add.style.display = (filterRowCount < maxFilterRows) ? "inline-block" : "none";
      } else if (sel.value === "no_condition" && filterRowCount < maxFilterRows) {
        add.style.display = "inline-block";
      }
    }
  });
}

// --- Initialization
document.addEventListener("DOMContentLoaded", () => {
  suppressAutoAdd = true;
  const urlParams = new URLSearchParams(window.location.search);
  const existing = [];
  for (let i = 1; i <= maxFilterRows; i++) {
    const ft = urlParams.get(`filter_type_${i}`);
    const fv = urlParams.get(`filter_value_${i}`);
    if (ft && ft !== "no_condition") existing.push({ type: ft, value: fv });
  }

  if (existing.length) {
    existing.forEach(f => addFilterRow(f.type, f.value));
    if (filterRowCount < maxFilterRows) addFilterRow();
  } else {
    addFilterRow();
  }

  document.querySelectorAll(".filter-select").forEach(sel => sel.dataset.prevValue = sel.value);
  suppressAutoAdd = false;
  updateAddRemoveButtonVisibility();
  updateAvailableFilters();
});
</script>



{% endblock %}
