{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title_block %} History {% endblock %}

{% block body_block %}
<a href="{% url 'App_Home:home_page' %}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Back
</a>

<div class="container mt-4">
    <h2 class="text-center mb-3">History</h2>

    <form method="GET" class="mb-4" id="dynamicSearchForm">
        <div id="filterRowsContainer">
            <!-- Initial filter row will be added here by JavaScript -->
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                <button type="button" class="btn btn-secondary" onclick="printResults()">Print</button>
            </div>
        </div>
    </form>

    <!-- Printable Table -->
    <div id="printableArea" class="table-responsive">
        <table class="table table-bordered table-striped table-hover text-center">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Allocation No</th>
                    <th>PBS</th>
                    <th>Package</th>
                    <th>Item</th>
                    <th>Unit</th>
                    <th>Warehouse</th>
                    <th>Quantity</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th>
                        CS&M<br>
                        <span style="font-size: 0.75em; font-style: italic;">(dd/mm/yyyy)</span>
                    </th>
                    <th>
                        Carry from Warehouse<br>
                        <span style="font-size: 0.75em; font-style: italic;">(dd/mm/yyyy)</span>
                    </th>
                    <th>
                        Comments<br>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                        <tr class="{% if item.remarks_status == 'Deleted' or item.status == 'Cancelled' %}table-danger{% endif %}">
                            <td>{{ item.allocation_no }}</td>
                            <td>{{ item.pbs }}</td>
                            <td>{{ item.package }}</td>
                            <td>{{ item.item }}</td>
                            <td>{{ item.unit_of_item }}</td>
                            <td>{{ item.warehouse }}</td>
                            <td>{{ item.quantity }}</td>
                            <td class="{% if item.status == 'Allocated' %}text-success{% elif item.status == 'Cancelled' %}text-danger{% elif item.status == 'Modified' %}text-primary{% endif %}">
                                <strong>{{ item.status }}</strong>
                            </td>
                            <td>{{ item.remarks|safe }}</td>

                         
                            <!-- CS&M -->
                            <td class="date-cell">
                                {% if item.CS_and_M == "N/A" %}
                                    <span class="text-danger"><b>N/A</b></span><br>
                                {% elif item.CS_and_M %}
                                    {% with day=item.CS_and_M|slice:"8:10" month=item.CS_and_M|slice:"5:7" year=item.CS_and_M|slice:"0:4" %}
                                            {{ day }}/{{ month }}/{{ year }}
                                    {% endwith %}
                                    <br>
                                {% endif %}

                                {% if can_edit_cs and item.status != 'Cancelled' and item.remarks_status != 'Deleted' %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn"
                                            onclick="showInput('{{ item.id }}', 'cs')">Update</button>
                                    <button class="btn btn-sm btn-outline-danger mt-1 update-btn"
                                            data-toggle="modal" data-target="#resetModal"
                                            onclick="setResetTarget('{{ item.id }}', 'cs')">Reset</button>

                                    <div id="input_cs_{{ item.id }}" style="display: none;" class="mt-1">
                                        <input type="date" id="date_cs_{{ item.id }}" class="form-control form-control-sm"
                                            {% if item.CS_and_M and item.CS_and_M != "N/A" %}
                                                value="{{ item.CS_and_M}}"
                                            {% endif %}>
                                        <button class="btn btn-sm btn-success mt-1"
                                                onclick="submitDate('{{ item.id }}', 'cs')">Save</button>
                                    </div>
                                {% endif %}
                            </td>

                            <!-- Carry From Warehouse -->
                            <td class="date-cell">
                                {% if item.carry_from_warehouse == "N/A" %}
                                    <span class="text-danger"><b>N/A</b></span><br>
                                {% elif item.carry_from_warehouse %}
                                    {% with day=item.carry_from_warehouse|slice:"8:10" month=item.carry_from_warehouse|slice:"5:7" year=item.carry_from_warehouse|slice:"0:4" %}
                                        {{ day }}/{{ month }}/{{ year }}
                                    {% endwith %}<br>
                                {% endif %}

                                {% if can_edit_carry and item.status != 'Cancelled' and item.remarks_status != 'Deleted' %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn"
                                            onclick="showInput('{{ item.id }}', 'carry')">Update</button>
                                    <button class="btn btn-sm btn-outline-danger mt-1 update-btn"
                                            data-toggle="modal" data-target="#resetModal"
                                            onclick="setResetTarget('{{ item.id }}', 'carry')">Reset</button>

                                    <div id="input_carry_{{ item.id }}" style="display: none;" class="mt-1">
                                        <input type="date" id="date_carry_{{ item.id }}" class="form-control form-control-sm"
                                               {% if item.carry_from_warehouse and item.carry_from_warehouse != "N/A" %}
                                                   value="{{ item.carry_from_warehouse }}"
                                               {% endif %}>
                                        <button class="btn btn-sm btn-success mt-1"
                                                onclick="submitDate('{{ item.id }}', 'carry')">Save</button>
                                    </div>
                                {% endif %}
                            </td>

                            <!-- Comments -->
                            <td class="comments-cell text-start">
                                {% if item.comments %}
                                    {{ item.comments|linebreaksbr }}<br>
                                {% endif %}

                                {% if can_edit_comments %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn" onclick="showCommentInput('{{ item.id }}')">Update</button>
                                    <div id="input_comments_{{ item.id }}" style="display: none;" class="mt-1">
                                        <textarea id="text_comments_{{ item.id }}" class="form-control form-control-sm" rows="3">{{ item.comments|default_if_none:"" }}</textarea>
                                        <button class="btn btn-sm btn-success mt-1" onclick="submitComment('{{ item.id }}')">Save</button>
                                    </div>
                                {% endif %}
                            </td>


                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" role="dialog" aria-labelledby="resetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg rounded">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="resetModalLabel">
          <i class="fa fa-exclamation-triangle"></i> Confirm Reset
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to reset this date? <b>This action cannot be undone.</b>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn">
          <i class="fa fa-check"></i> Yes, Reset
        </button>
      </div>
    </div>
  </div>
</div>

<style>
    .date-cell button.update-btn { display: none; }
    .date-cell:hover button.update-btn { display: inline-block; }

    .comments-cell button.update-btn {
        display: none;
    }
    .comments-cell:hover button.update-btn {
        display: inline-block;
    }

    @media print {
        body * { visibility: hidden; }
        #printableArea, #printableArea * { visibility: visible; }
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
</style>

<script>
    const ALL_FILTER_OPTIONS = [
        { value: "no_condition", text: "No Condition", type: "none" },
        { value: "allocation_no", text: "Allocation No", type: "text" },
        { value: "pbs", text: "PBS", type: "text" },
        { value: "package", text: "Package", type: "text" },
        { value: "item", text: "Item", type: "text" },
        { value: "warehouse", text: "Warehouse", type: "text" },
        { value: "status", text: "Status", type: "status_dropdown" },
        { value: "cs_and_m_date", text: "CS&M Date", type: "date" },
        { value: "carry_from_warehouse_date", text: "Carry from Warehouse Date", type: "date" },
    ];

    const STATUS_CHOICES = JSON.parse('{{ status_choices_json|escapejs }}'); // Passed from Django view

    let filterRowCount = 0;
    const maxFilterRows = 9; // Maximum number of filter rows

    function getSelectedFilterValues() {
        const selectedValues = [];
        document.querySelectorAll('.filter-select').forEach(select => {
            if (select.value !== "no_condition") {
                selectedValues.push(select.value);
            }
        });
        return selectedValues;
    }

    function updateAvailableFilters() {
        const selectedValues = getSelectedFilterValues();
        document.querySelectorAll('.filter-select').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = ''; // Clear existing options

            ALL_FILTER_OPTIONS.forEach(option => {
                // Always include "No Condition"
                // Include the current value of the select box
                // Include options that haven't been selected in other dropdowns
                if (option.value === "no_condition" || option.value === currentValue || !selectedValues.includes(option.value)) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    select.appendChild(opt);
                }
            });
            select.value = currentValue; // Restore the selected value
        });
    }

    function updateFilterRow(selectElement) {
        const row = selectElement.closest('.filter-row');
        const filterType = selectElement.value;
        const inputContainer = row.querySelector('.input-container');
        inputContainer.innerHTML = ''; // Clear previous input

        const filterOption = ALL_FILTER_OPTIONS.find(opt => opt.value === filterType);
        const filterIndex = row.dataset.filterIndex;

        if (filterOption && filterOption.type === "text") {
            inputContainer.innerHTML = `
                <input type="text" name="filter_value_${filterIndex}" class="form-control" placeholder="${filterOption.text}" value="">
            `;
        } else if (filterOption && filterOption.type === "date") {
            inputContainer.innerHTML = `
                <input type="date" name="filter_value_${filterIndex}" class="form-control mb-2" value="">
                <select name="date_status_${filterIndex}" class="form-select">
                    <option value="all">Show All Data</option>
                    <option value="empty">Show Empty Cells</option>
                </select>
            `;
        } else if (filterOption && filterOption.type === "status_dropdown") {
            let optionsHtml = '';
            STATUS_CHOICES.forEach(choice => {
                optionsHtml += `<option value="${choice[0]}">${choice[1]}</option>`;
            });
            inputContainer.innerHTML = `
                <select name="filter_value_${filterIndex}" class="form-select">
                    ${optionsHtml}
                </select>
            `;
        }
        // If "no_condition" or type "none", inputContainer remains empty

        updateAvailableFilters();
        updateAddRemoveButtonVisibility(); // Update visibility after a filter row is changed
    }

    function addFilterRow(initialFilter = "no_condition", initialValue = "") {
        if (filterRowCount >= maxFilterRows) {
            return; // Do not add more rows than maxFilterRows
        }

        filterRowCount++;
        const filterIndex = filterRowCount; // Use 1-based indexing for filterIndex
        const container = document.getElementById('filterRowsContainer');
        const row = document.createElement('div');
        row.classList.add('row', 'g-3', 'mb-3', 'filter-row');
        row.dataset.filterIndex = filterIndex;
        row.innerHTML = `
            <div class="col-md-4">
                <select name="filter_type_${filterIndex}" class="form-select filter-select" onchange="updateFilterRow(this)">
                    <!-- Options will be populated by updateAvailableFilters -->
                </select>
            </div>
            <div class="col-md-6 input-container">
                <!-- Input field will be dynamically added here -->
            </div>
            <div class="col-md-2 d-flex justify-content-end">
                <button type="button" class="btn btn-danger remove-filter-row me-1" onclick="removeFilterRow(this)">
                    <i class="fa fa-times"></i>
                </button>
                <button type="button" class="btn btn-info add-filter-row-btn" style="display: none;">
                    <i class="fa fa-plus"></i> Add
                </button>
            </div>
        `;
        container.appendChild(row);

        const selectElement = row.querySelector('.filter-select');
        updateAvailableFilters(); // Populate options for the new select
        selectElement.value = initialFilter; // Set initial filter
        updateFilterRow(selectElement); // Initialize input field based on initial filter

        // Handle initial value if provided (e.g., on page load with existing filters)
        if (initialValue) {
            const inputField = row.querySelector(`[name="filter_value_${filterIndex}"]`);
            if (inputField) {
                inputField.value = initialValue;
            }
        }

        // Attach event listener to the new add button in this row
        row.querySelector('.add-filter-row-btn').addEventListener('click', () => addFilterRow());

        updateAddRemoveButtonVisibility();
    }

    function removeFilterRow(buttonElement) {
        const row = buttonElement.closest('.filter-row');
        row.remove();
        filterRowCount--; // Decrement count
        updateAvailableFilters();
        updateAddRemoveButtonVisibility();
    }

    function updateAddRemoveButtonVisibility() {
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach((row, index) => {
            const removeBtn = row.querySelector('.remove-filter-row');
            const addBtn = row.querySelector('.add-filter-row-btn');
            const selectElement = row.querySelector('.filter-select');

            // Remove button visibility
            if (filterRowCount <= 1) {
                removeBtn.style.display = 'none';
            } else {
                removeBtn.style.display = 'block';
            }

            // Add button visibility
            addBtn.style.display = 'none'; // Hide all add buttons by default
            if (index === filterRows.length - 1 && filterRowCount < maxFilterRows && selectElement.value !== "no_condition") {
                addBtn.style.display = 'block'; // Show add button only on the last row if conditions met
            }
        });
    }


    function printResults() { window.print(); }

    // Existing functions for update_date_view and comments...
    function showInput(id, field) {
        document.getElementById(`input_${field}_${id}`).style.display = 'block';
    }

    function submitDate(id, field) {
        const datetime = document.getElementById(`date_${field}_${id}`).value;
        if (!datetime) return alert("Please select a date.");

        fetch(`/history/update-date/${id}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ field: field, date: datetime })
        }).then(res => {
            if (res.ok) location.reload();
            else res.json().then(data => alert(data.error || "Failed"));
        });
    }

    function showCommentInput(id) {
        const container = document.getElementById(`input_comments_${id}`);
        container.style.display = 'block';

        const textarea = document.getElementById(`text_comments_${id}`);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    }

    function submitComment(id) {
        const comment = document.getElementById(`text_comments_${id}`).value;

        fetch(`/history/update-date/${id}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ field: "comments", text: comment })
        }).then(res => {
            if (res.ok) location.reload();
            else res.json().then(data => alert(data.error || "Failed"));
        });
    }

    let resetTargetId = null;
    let resetTargetField = null;

    function setResetTarget(id, field) {
        resetTargetId = id;
        resetTargetField = field;
    }

    document.getElementById("confirmResetBtn").addEventListener("click", function() {
        if (!resetTargetId || !resetTargetField) return;

        fetch(`/history/update-date/${resetTargetId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ field: resetTargetField, reset: true })
        }).then(res => {
            $('#resetModal').modal('hide');
            if (res.ok) location.reload();
            else res.json().then(data => alert(data.error || "Failed"));
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        let existingFilters = [];
        for (let i = 1; i <= maxFilterRows; i++) {
            const filterType = urlParams.get(`filter_type_${i}`);
            const filterValue = urlParams.get(`filter_value_${i}`);
            const dateStatus = urlParams.get(`date_status_${i}`);

            if (filterType && filterType !== "no_condition") {
                existingFilters.push({ type: filterType, value: filterValue, dateStatus: dateStatus });
            }
        }

        if (existingFilters.length > 0) {
            existingFilters.forEach(filter => {
                addFilterRow(filter.type, filter.value);
                if (filter.dateStatus) {
                    // Find the last added row (which corresponds to the current filter)
                    const lastAddedRow = document.querySelector(`.filter-row[data-filter-index="${filterRowCount}"]`);
                    if (lastAddedRow) {
                        const dateStatusSelect = lastAddedRow.querySelector(`[name="date_status_${filterRowCount}"]`);
                        if (dateStatusSelect) {
                            dateStatusSelect.value = filter.dateStatus;
                        }
                    }
                }
            });
        } else {
            addFilterRow(); // Add one empty row if no existing filters
        }

        updateRemoveButtonsVisibility();
        updateAddFilterButtonVisibility();
    });
</script>
{% endblock %}
