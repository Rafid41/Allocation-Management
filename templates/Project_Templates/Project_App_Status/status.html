{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block title_block %} Project Status {% endblock %}

{% block body_block %}
<a href="{% url 'Project_App_Home:project_home_page' %}" class="btn btn-outline-dark mb-3">
    <i class="fa fa-arrow-left"></i> Back
</a>
<center><h1><b> Project Status </b></h1></center>
<div class="container mt-4">
    <h2>Search Items</h2>

    <form method="GET" action="{% url 'Project_App_Status:status_page' %}" class="row g-3" id="searchForm" {% if is_print_view %}style="display:none;"{% endif %}>
        <div id="filter-container">
            <!-- Filter rows will be added here by JavaScript -->
        </div>
        <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary me-3">Search</button>
            <button type="button" class="btn btn-secondary me-2" onclick="printResults()">Print</button>
            <button type="button" class="btn btn-success" onclick="exportToExcelGeneric()">
                <i class="fa fa-file-excel-o"></i> Export to Excel (.xlsx)
            </button>
        </div>
    </form>

    <h4>Search Results</h4>

    <div id="printableArea" class="table-responsive">
        <h3 class="text-center">Project Status</h3>
        <br>
        <table class="table table-bordered table-striped table-hover" id="statusTable">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Project ID</th>
                    <th>Item Name</th>
                    <th>Warehouse</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Entry/Update Date <center>yyyy-mm-dd</center></th>
                    <th>Comments</th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                    <tr>
                        <td>{{ item.project.projectId }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.warehouse }}</td>
                        <td>{{ item.unit_of_item }}</td>
                        <td>{{ item.quantity_of_item }}</td>
                        <td>{{ item.created_at | date:"Y-m-d" }}</td>

                        <!-- Comments Column -->
                        <td class="comments-cell text-start">
                            {% if item.comments %}
                                {{ item.comments|linebreaksbr }}<br>
                            {% endif %}
                            {% if can_edit_comments %}
                            <button class="btn btn-sm btn-outline-primary mt-1 update-btn" onclick="showCommentInput('{{ item.id }}')">Update</button>
                            <div id="input_comments_{{ item.id }}" style="display: none;" class="mt-1">
                                <textarea id="text_comments_{{ item.id }}" class="form-control form-control-sm" rows="3">{{ item.comments|default_if_none:"" }}</textarea>
                                <button class="btn btn-sm btn-success mt-1" onclick="submitComment('{{ item.id }}')">Save</button>
                            </div>
                            {% endif %}
                        </td>

                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    </div>

    {% if not is_print_view and items.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-5 mb-5">
      <ul class="pagination justify-content-center custom-pagination">
        
        <!-- First Page -->
        <li class="page-item {% if not items.has_previous %}disabled{% endif %}">
          <a class="page-link btn-nav btn-first-last" href="#" onclick="goToPage(1); return false;" aria-label="First">
            <i class="fa fa-angle-double-left"></i> First
          </a>
        </li>

        <!-- Previous Page -->
        <li class="page-item {% if not items.has_previous %}disabled{% endif %}">
          <a class="page-link btn-nav btn-prev-next" href="#" onclick="{% if items.has_previous %}goToPage({{ items.previous_page_number }});{% endif %} return false;" aria-label="Previous">
            <i class="fa fa-angle-left"></i> Prev
          </a>
        </li>

        <!-- Page Numbers -->
        {% for i in items.paginator.page_range %}
          {% if i > items.number|add:'-4' and i < items.number|add:'4' %}
            <li class="page-item {% if items.number == i %}active{% endif %}">
              <a class="page-link" href="#" onclick="goToPage({{ i }}); return false;">{{ i }}</a>
            </li>
          {% endif %}
        {% endfor %}

        <!-- Next Page -->
        <li class="page-item {% if not items.has_next %}disabled{% endif %}">
          <a class="page-link btn-nav btn-prev-next" href="#" onclick="{% if items.has_next %}goToPage({{ items.next_page_number }});{% endif %} return false;" aria-label="Next">
             Next <i class="fa fa-angle-right"></i>
          </a>
        </li>

        <!-- Last Page -->
        <li class="page-item {% if not items.has_next %}disabled{% endif %}">
           <a class="page-link btn-nav btn-first-last" href="#" onclick="goToPage({{ items.paginator.num_pages }}); return false;" aria-label="Last">
            Last <i class="fa fa-angle-double-right"></i>
          </a>
        </li>

      </ul>
    </nav>
    {% endif %}
</div>

<style>
    /* Improve table readability */
    .table {
        font-size: 16px;
        text-align: center;
    }

    /* Fixed table header */
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1020;
    }

    /* Make table header stand out */
    .table-dark th {
        background-color: #343a40 !important;
        color: white !important;
    }

    /* Improve spacing and border visibility */
    .table-bordered th, .table-bordered td {
        border: 1px solid #ddd !important;
        padding: 10px;
    }

    /* Hover effect for better interaction */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Hide unnecessary elements when printing */
    @media print {
        body * {
            visibility: hidden;
        }
        #printableArea, #printableArea * {
            visibility: visible;
        }
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }

        /* Add margins to the printed page */
        @page {
            size: A4;
            margin: 0.5in;
        }

        /* Hide the page title and URL */
        @media print {
            @page {
                margin: 0.5in;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            h1, h2 {
                display: none;
            }
        }
    }

    .comments-cell button.update-btn { display: none; }
    .comments-cell:hover button.update-btn { display: inline-block; }

    /* Custom Deeper Colors */
    .table-light-green, .table-light-green > th, .table-light-green > td {
        background-color: #84eab3 !important;  /* soft light green */
    }

    /* Custom Pagination Styles */
    .custom-pagination {
        background: #ffffff;
        padding: 10px 20px;
        border-radius: 50px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        align-items: center;
    }
    .custom-pagination .page-item {
        margin: 0 3px;
    }
    .custom-pagination .page-link {
        border: none;
        border-radius: 50px; /* Pill shape for all */
        min-width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
        padding: 0 10px;
        color: #555;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-block;
    }
    .custom-pagination .page-link:hover {
        background-color: #f0f0f0;
        color: #333;
        transform: translateY(-2px);
    }
    
    /* Active Page Number */
    .custom-pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 10px rgba(118, 75, 162, 0.4);
        transform: scale(1.1);
        min-width: 40px; /* Keep page nums circular-ish if single digit */
    }

    /* Navigation Buttons (Base) */
    .custom-pagination .btn-nav {
        padding: 0 15px;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Prev/Next Color Scheme (e.g., Cool Blue/Cyan) */
    .custom-pagination .btn-prev-next {
        background-color: #e0f2fe; /* light blue */
        color: #0284c7; /* dark blue text */
    }
    .custom-pagination .btn-prev-next:hover {
        background-color: #0ea5e9; /* vivid blue hover */
        color: white;
    }

    /* First/Last Color Scheme (e.g., Warm Orange/Rose or different tone) */
    .custom-pagination .btn-first-last {
        background-color: #ffe4e6; /* light rose */
        color: #e11d48; /* dark rose/red text */
        font-weight: 700;
    }
    .custom-pagination .btn-first-last:hover {
        background-color: #f43f5e; /* vivid rose hover */
        color: white;
    }

    .custom-pagination .page-item.disabled .page-link {
        color: #ccc;
        background-color: transparent !important;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }
</style>

<script>
    const filterOptions = [
        "No Condition",
        "Project ID",
        "Item Name",
        "Warehouse",
        "Unit",
        "Entry/Update Date"
    ];

    // Helper to get option properties from its value
    function getFilterOptionProperties(value) {
        switch (value) {
            case "No Condition": return { hasInput: false };
            case "Project ID": return { hasInput: true, inputType: "text" };
            case "Item Name": return { hasInput: true, inputType: "text" };
            case "Warehouse": return { hasInput: true, inputType: "text" };
            case "Unit": return { hasInput: true, inputType: "select" };
            case "Entry/Update Date": return { hasInput: true, inputType: "date" };
            default: return { hasInput: false };
        }
    }

    let activeFilterRowCount = 0;
    const maxFilterRows = 5; // Maximum 5 filter rows with input fields

    function createFilterRow(index, initialFilterBy = "No Condition", initialQuery = "") {
        const filterContainer = document.getElementById("filter-container");
        const rowId = `filter-row-${index}`;

        const rowDiv = document.createElement("div");
        rowDiv.className = "row g-3 mb-2 align-items-center";
        rowDiv.id = rowId;

        const inputFieldHtml = (initialFilterBy === "Unit") ?
            `<select name="query_${index}" id="searchQuery_${index}" class="form-select search-query">
                <option value="">Select Unit</option>
                {% for unit in unique_units %}
                    <option value="{{ unit }}" {% if unit == initialQuery %}selected{% endif %}>{{ unit }}</option>
                {% endfor %}
            </select>` :
            `<input type="text" name="query_${index}" id="searchQuery_${index}" class="form-control search-query" placeholder="Search..." value="${initialQuery}">`;

        rowDiv.innerHTML = `
            <div class="col-md-5">
                <select name="filter_by_${index}" id="filterDropdown_${index}" class="form-select filter-dropdown">
                </select>
            </div>
            <div class="col-md-5">
                ${inputFieldHtml}
            </div>
            <div class="col-md-2 d-flex justify-content-end">
                <button type="button" class="btn btn-danger remove-filter-btn me-1" data-index="${index}" style="display: none;">
                    <i class="fa fa-times"></i>
                </button>
                <button type="button" class="btn btn-info add-filter-btn" data-index="${index}" style="display: none;">
                    <i class="fa fa-plus"></i> Add
                </button>
            </div>
        `;
        filterContainer.appendChild(rowDiv);
        activeFilterRowCount++; // Increment active count

        const dropdown = document.getElementById(`filterDropdown_${index}`);
        if (!dropdown) {
            console.error(`Dropdown element with ID filterDropdown_${index} not found.`);
            return; // Exit if dropdown not found
        }
        const inputField = document.getElementById(`searchQuery_${index}`); // This will now be the select or input
        const removeBtn = rowDiv.querySelector(".remove-filter-btn");
        const addBtn = rowDiv.querySelector(".add-filter-btn"); // Get the new add button

        // Populate dropdown options
        updateDropdownOptions(dropdown, index);

        // Set initial selected value
        dropdown.value = initialFilterBy;

        // Handle initial input field visibility and type
        const selectedOptionProps = getFilterOptionProperties(initialFilterBy);
        if (selectedOptionProps.hasInput) {
            inputField.style.display = "block";
            if (selectedOptionProps.inputType !== "select") { // Only set type if not a select
                inputField.type = selectedOptionProps.inputType;
            }
        } else {
            inputField.style.display = "none";
        }

        // Event listener for dropdown change
        dropdown.addEventListener("change", function() {
            const selectedOptionProps = getFilterOptionProperties(this.value);
            const currentInputField = document.getElementById(`searchQuery_${index}`); // Get current input field
            const previousValue = currentInputField ? currentInputField.value : ""; // Store previous value

            // Recreate input field based on new selection
            let newInputFieldHtml;
            if (this.value === "Unit") {
                newInputFieldHtml = `<select name="query_${index}" id="searchQuery_${index}" class="form-select search-query">
                    <option value="">Select Unit</option>
                    {% for unit in unique_units %}
                        <option value="{{ unit }}">{{ unit }}</option>
                    {% endfor %}
                </select>`;
            } else if (selectedOptionProps.hasInput) {
                newInputFieldHtml = `<input type="${selectedOptionProps.inputType}" name="query_${index}" id="searchQuery_${index}" class="form-control search-query" placeholder="Search..." value="${previousValue}">`;
            } else {
                newInputFieldHtml = `<input type="hidden" name="query_${index}" id="searchQuery_${index}" class="form-control search-query">`; // Hidden input for no condition
            }

            // Replace the old input field with the new one
            currentInputField.outerHTML = newInputFieldHtml;
            const updatedInputField = document.getElementById(`searchQuery_${index}`);
            if (selectedOptionProps.hasInput) {
                updatedInputField.style.display = "block";
            } else {
                updatedInputField.style.display = "none";
            }
            // Restore previous value if applicable and handle selection for unit dropdown
            if (this.value === "Unit" && previousValue) {
                const trimmedPreviousValue = previousValue.trim();
                for (let i = 0; i < updatedInputField.options.length; i++) {
                    if (updatedInputField.options[i].value === trimmedPreviousValue) {
                        updatedInputField.options[i].selected = true;
                        break;
                    }
                }
            } else {
                updatedInputField.value = previousValue; // Restore previous value for other input types
            }

            // Update options for all subsequent dropdowns
            document.querySelectorAll('.filter-dropdown').forEach((otherDropdown, idx) => {
                updateDropdownOptions(otherDropdown, parseInt(otherDropdown.id.split('_')[1]));
            });

            // Show next filter row if a condition is selected and not maxed out
            if (this.value !== "No Condition" && index === (activeFilterRowCount - 1) && activeFilterRowCount < maxFilterRows) {
                createFilterRow(activeFilterRowCount); // Use activeFilterRowCount as the new index
                document.getElementById(`filter-row-${activeFilterRowCount - 1}`).style.display = "flex"; // Display the newly created row
            } else if (this.value === "No Condition" && index < (activeFilterRowCount - 1)) {
                // If a middle dropdown is set to "No Condition", remove subsequent rows
                removeFilterRow(index + 1);
            }
            updateRemoveButtons();
            updateAddFilterButton(); // Call to update add button visibility
        });

        // Event listener for remove button
        removeBtn.addEventListener("click", function() {
            const idxToRemove = parseInt(this.dataset.index);
            removeFilterRow(idxToRemove);
            updateRemoveButtons();
            // Update options for all dropdowns after removal
            document.querySelectorAll('.filter-dropdown').forEach((otherDropdown, idx) => {
                updateDropdownOptions(otherDropdown, parseInt(otherDropdown.id.split('_')[1]));
            });
            updateAddFilterButton(); // Call to update add button visibility
        });

        // Event listener for the new add button
        addBtn.addEventListener("click", function() {
            if (activeFilterRowCount < maxFilterRows) {
                createFilterRow(activeFilterRowCount);
                document.getElementById(`filter-row-${activeFilterRowCount - 1}`).style.display = "flex";
                updateAddFilterButton();
                updateRemoveButtons();
            }
        });

        updateRemoveButtons();
        updateAddFilterButton();
    }

    function updateDropdownOptions(dropdownElement, currentIndex) {
        const selectedValues = new Set();
        // Collect all selected values from other dropdowns
        document.querySelectorAll('.filter-dropdown').forEach((otherDropdown) => {
            if (otherDropdown.id !== dropdownElement.id && otherDropdown.value !== "No Condition") {
                selectedValues.add(otherDropdown.value);
            }
        });

        const currentSelectedValue = dropdownElement.value; // Store current selection

        // Clear existing options
        dropdownElement.innerHTML = "";

        // Add "No Condition" first
        const noConditionOption = document.createElement("option");
        noConditionOption.value = "No Condition";
        noConditionOption.textContent = "No Condition";
        dropdownElement.appendChild(noConditionOption);

        // Add other options, excluding already selected ones
        filterOptions.forEach(optionValue => {
            if (optionValue !== "No Condition" && !selectedValues.has(optionValue)) {
                const opt = document.createElement("option");
                opt.value = optionValue;
                opt.textContent = optionValue; // Text content is the same as value for now
                dropdownElement.appendChild(opt);
            }
        });

        // Restore previous selection if it's still a valid option, otherwise default to "No Condition"
        if (Array.from(dropdownElement.options).some(opt => opt.value === currentSelectedValue)) {
            dropdownElement.value = currentSelectedValue;
        } else {
            dropdownElement.value = "No Condition";
        }
    }

    function removeFilterRow(startIndex) {
        for (let i = startIndex; i < activeFilterRowCount; i++) {
            const row = document.getElementById(`filter-row-${i}`);
            if (row) {
                row.remove();
            }
        }
        activeFilterRowCount = startIndex; // Set active count to the start index
        if (activeFilterRowCount < 0) activeFilterRowCount = 0; // Ensure it doesn't go below 0
        updateAddFilterButton();
        updateRemoveButtons();
    }

    function updateRemoveButtons() {
        document.querySelectorAll(".remove-filter-btn").forEach(btn => {
            btn.style.display = "none"; // Hide all by default
        });

        // Show remove button for all rows except the first one, if there's more than one active filter row
        if (activeFilterRowCount > 1) { // Only show remove buttons if there's more than one filter row
            for (let i = 1; i < activeFilterRowCount; i++) { // Start from the second row (index 1)
                const row = document.getElementById(`filter-row-${i}`);
                if (row) {
                    row.querySelector(".remove-filter-btn").style.display = "block";
                }
            }
        }
    }

    function updateAddFilterButton() {
        // Hide all add buttons first
        document.querySelectorAll(".add-filter-btn").forEach(btn => {
            btn.style.display = "none";
        });

        // Only show add button on the last active filter row if conditions are met
        if (activeFilterRowCount > 0 && activeFilterRowCount < maxFilterRows) {
            const lastRowIndex = activeFilterRowCount - 1;
            const lastDropdown = document.getElementById(`filterDropdown_${lastRowIndex}`);
            const lastAddBtn = document.getElementById(`filter-row-${lastRowIndex}`).querySelector(".add-filter-btn");

            if (lastDropdown && lastDropdown.value !== "No Condition" && lastAddBtn) {
                lastAddBtn.style.display = "block";
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Initialize the first filter row
        createFilterRow(0, "{{ filter_by_0|default:'No Condition' }}", "{{ query_0|default:'' }}");

        // Re-create rows based on existing query parameters if page reloads with filters
        let initialActiveRows = 0;
        {% for i in "1234" %} {# Loop for up to 4 additional filters #}
            {% with filter_by_key="filter_by_"|add:i|stringformat:"s" query_key="query_"|add:i|stringformat:"s" %}
                {% if request.GET|get_item:filter_by_key %}
                    createFilterRow({{ i }}, "{{ request.GET|get_item:filter_by_key }}", "{{ request.GET|get_item:query_key }}");
                    document.getElementById(`filter-row-{{ i }}`).style.display = "flex";
                    initialActiveRows = {{ i }} + 1;
                {% endif %}
            {% endwith %}
        {% endfor %}

        // Ensure activeFilterRowCount reflects the number of rows created during initialization
        activeFilterRowCount = initialActiveRows > 0 ? initialActiveRows : 1; // At least one row is always active

        // If the first row is "No Condition" and no other filters, hide add button
        const firstDropdown = document.getElementById(`filterDropdown_0`);
        if (firstDropdown && firstDropdown.value === "No Condition" && activeFilterRowCount === 1) {
            // No need to hide add button here, updateAddFilterButton handles it
        }

        updateRemoveButtons();
        updateAddFilterButton();
    });

    {% if is_print_view %}
      window.onload = function() {
          // Auto-print when loaded in print view
          window.print();
      };
    {% endif %}

    function goToPage(n) {
      const p = new URLSearchParams(window.location.search);
      p.set('page', n);
      window.location.search = p.toString();
    }

    function printResults() {
        const p = new URLSearchParams(window.location.search);
        p.set('print_view', 'true');
        window.open('?' + p.toString(), '_blank');
    }

    function exportToExcelGeneric() {
        const p = new URLSearchParams(window.location.search);
        // If we are already in print view (full data), just export immediately
        if (p.get('print_view') === 'true') {
            exportToExcel(document.getElementById('statusTable'));
        } else {
            // Fetch print view background and export that
            p.set('print_view', 'true');
            const btn = document.querySelector('button[onclick="exportToExcelGeneric()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Exporting...';
            btn.disabled = true;

            fetch('?' + p.toString())
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const table = doc.getElementById('statusTable');
                    exportToExcel(table);
                })
                .catch(err => alert("Export failed: " + err))
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }
    }

    function showCommentInput(id) {
        const container = document.getElementById(`input_comments_${id}`);
        container.style.display = 'block';

        const textarea = document.getElementById(`text_comments_${id}`);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    }

    function submitComment(id) {
        const comment = document.getElementById(`text_comments_${id}`).value;

        fetch(`/project/project_status/update-comment/${id}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": '{{ csrf_token }}',
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ text: comment })
        }).then(res => {
            if (res.ok) location.reload();
            else res.json().then(data => alert(data.error || "Failed"));
        });
    }

    function exportToExcel(sourceTable) {
        try {
            if (typeof XLSX === 'undefined') {
                alert('SheetJS (XLSX) library not loaded. Make sure you included it in base.html.');
                return;
            }

            const originalTable = sourceTable || document.getElementById('statusTable');
            
            // Create a new table in memory
            const newTable = document.createElement('table');
            
            // Create and append the header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            originalTable.querySelectorAll('thead th').forEach((th, index) => {
                const newTh = document.createElement('th');
                const b = document.createElement('b');
                let headerText = th.innerText.trim();
                if (index === 5) { // "Entry/Update Date" is the 6th column (index 5)
                    headerText = "Entry/Update Date (dd-mm-yyyy)";
                }
                b.innerText = headerText;
                newTh.appendChild(b);
                headerRow.appendChild(newTh);
            });
            thead.appendChild(headerRow);
            newTable.appendChild(thead);

            // Clone and append the body
            const tbody = originalTable.querySelector('tbody').cloneNode(true);
            // Remove update buttons and edit boxes from the cloned table's comments column
            tbody.querySelectorAll('.comments-cell .update-btn, .comments-cell div[id^="input_comments_"]').forEach(el => el.remove());
            newTable.appendChild(tbody);

            // Convert the new table to a worksheet
            const ws = XLSX.utils.table_to_sheet(newTable);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 }, // Project ID
                { wch: 30 }, // Item Name
                { wch: 12 }, // Warehouse
                { wch: 5 }, // Unit
                { wch: 12 }, // Quantity
                { wch: 28 }, // Entry/Update Date
                { wch: 40 }  // Comments
            ];

            // Center align Project ID column (column 0 in 0-based index, A in Excel)
            // Iterate over all cells in the Project ID column (column 0)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const cell_address = { c: 0, r: R }; // Column 0 (Project ID)
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                if (!ws[cell_ref]) continue;
                if (!ws[cell_ref].s) ws[cell_ref].s = {};
                ws[cell_ref].s.alignment = { horizontal: "center" };
            }

            // Make workbook and append sheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Project Status');

            const filename = `Project Status.xlsx`;

            XLSX.writeFile(wb, filename);
        } catch (err) {
            console.error(err);
            alert('Export failed: ' + (err && err.message ? err.message : err));
        }
    }
</script>
{% endblock %}
