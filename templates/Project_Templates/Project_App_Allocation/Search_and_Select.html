{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title_block %} Search and Select Item for Allocation {% endblock %}

{% block body_block %}
<!-- Display Success & Error Messages -->
{% if messages %}
    {% for message in messages %}
    <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
        <i class="fa {% if message.tags == 'success' %}fa-check-circle text-success{% else %}fa-exclamation-circle text-danger{% endif %}"></i>
        {{ message }}
        <button type="button" class="custom-close" data-bs-dismiss="alert" aria-label="Close">X</button>
    </div>
    {% endfor %}
{% endif %}

<a href="{% url 'Project_App_Allocation:select_allocation_number' %}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Back
</a>

<center>
    <h1 class="fw-bold text-primary"><b> Search and Select Project Item for Project Allocation </b></h1>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6 col-lg-4 mx-auto">
                <div class="card shadow-sm border-primary p-3 text-center">
                    {% if allocation_number %}
                    <h4 class="fw-bold mt-2">Allocation Number: <b class="text-danger">{{ allocation_number }}</b></h4>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</center>

<br>
<div class="d-flex justify-content-center">
    <a href="{%url 'Project_App_Allocation:view_confirm_allocation' allocation_id %}" class="btn btn-warning d-flex align-items-center">
        <i class="fas fa-eye mr-2"></i> View and Confirm current Project Allocation
    </a>
</div>

<div class="container mt-3">
    <br>
    <h2>Search Items</h2>

    <!-- SEARCH FORM -->
    <form method="GET" action="{% url 'Project_App_Allocation:Search_and_Select' allocation_id %}" class="row g-3" id="searchForm">
        <div id="filter-container">
            <!-- Dynamic filter rows inserted here by JS -->
        </div>

        <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary me-3">Search</button>
        </div>
    </form>

    <hr>

    <h4 class="text-secondary">Search Results</h4>

    <div class="table-responsive">
        <h3 class="text-center text-primary"><b>Choose Project Entry</b></h3>
        <br>
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Project ID</th>
                    <th>Item Name</th>
                    <th>Warehouse</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Entry/Update date</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                    <tr class="selectable-row">
                        <td>{% if item.project %}{{ item.project.projectId }}{% else %}-{% endif %}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.warehouse }}</td>
                        <td>{{ item.unit_of_item }}</td>
                        <td>{{ item.quantity_of_item }}</td>
                        <td>{{ item.created_at }}</td>
                        <td>
                            <a href="{% url 'Project_App_Allocation:allocate_item' allocation_id item.id %}" 
                               class="btn btn-success btn-sm select-btn">
                                <i class="fas fa-check"></i> Select
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>


<!-- FILTER SYSTEM JS -->
<script>
    const filterOptions = [
        "No Condition",
        "Project ID",
        "Item Name",
        "Warehouse",
        "Entry/Update Date"
    ];

    function getFilterOptionProperties(value) {
        switch (value) {
            case "No Condition": return { hasInput: false };
            case "Project ID": return { hasInput: true, inputType: "text" };
            case "Item Name": return { hasInput: true, inputType: "text" };
            case "Warehouse": return { hasInput: true, inputType: "select" };
            case "Entry/Update Date": return { hasInput: true, inputType: "date" };
            default: return { hasInput: false };
        }
    }

    let activeFilterRowCount = 0;
    const maxFilterRows = 5;

    function createFilterRow(index, initialFilterBy = "No Condition", initialQuery = "") {

        const filterContainer = document.getElementById("filter-container");
        const rowId = `filter-row-${index}`;

        const rowDiv = document.createElement("div");
        rowDiv.className = "row g-3 mb-2 align-items-center";
        rowDiv.id = rowId;

        let inputFieldHtml = '';
        const selectedOptionProps = getFilterOptionProperties(initialFilterBy);

        if (initialFilterBy === "Warehouse") {
            inputFieldHtml = `<select name="query_${index}" id="searchQuery_${index}" class="form-select search-query">
                <option value="">Select Warehouse</option>
                {% for warehouse in unique_warehouses %}
                    <option value="{{ warehouse }}">{{ warehouse }}</option>
                {% endfor %}
            </select>`;
        } else if (selectedOptionProps.hasInput) {
            inputFieldHtml = `<input type="${selectedOptionProps.inputType}" name="query_${index}" id="searchQuery_${index}" class="form-control search-query" placeholder="Search..." value="${initialQuery}">`;
        } else {
            inputFieldHtml = `<input type="hidden" name="query_${index}" id="searchQuery_${index}" class="form-control search-query">`;
        }

        rowDiv.innerHTML = `
            <div class="col-md-5">
                <select name="filter_by_${index}" id="filterDropdown_${index}" class="form-select filter-dropdown"></select>
            </div>
            <div class="col-md-5">
                ${inputFieldHtml}
            </div>
            <div class="col-md-2 d-flex justify-content-end">
                <button type="button" class="btn btn-danger remove-filter-btn me-1" data-index="${index}" style="display:none;">
                    <i class="fa fa-times"></i>
                </button>
                <button type="button" class="btn btn-info add-filter-btn" data-index="${index}" style="display:none;">
                    <i class="fa fa-plus"></i> Add
                </button>
            </div>
        `;

        filterContainer.appendChild(rowDiv);
        activeFilterRowCount++;

        const dropdown = document.getElementById(`filterDropdown_${index}`);
        const inputField = document.getElementById(`searchQuery_${index}`);
        const removeBtn = rowDiv.querySelector(".remove-filter-btn");
        const addBtn = rowDiv.querySelector(".add-filter-btn");

        updateDropdownOptions(dropdown, index);

        dropdown.value = initialFilterBy;

        // *** IMPORTANT: Fix warehouse selected value after search ***
        if (initialFilterBy === "Warehouse" && initialQuery) {
            const sel = document.getElementById(`searchQuery_${index}`);
            const trimmedInitial = initialQuery.trim();

            setTimeout(() => {
                if (Array.from(sel.options).some(opt => opt.value === trimmedInitial)) {
                    sel.value = trimmedInitial;
                }
            }, 10);
        }

        if (selectedOptionProps.hasInput) inputField.style.display = "block";
        else inputField.style.display = "none";

        dropdown.addEventListener("change", function () {
            const selectedOptionProps = getFilterOptionProperties(this.value);
            const currentInputField = document.getElementById(`searchQuery_${index}`);
            const previousValue = currentInputField ? currentInputField.value : "";

            let newInputFieldHtml;
            if (this.value === "Warehouse") {
                newInputFieldHtml = `<select name="query_${index}" id="searchQuery_${index}" class="form-select search-query">
                    <option value="">Select Warehouse</option>
                    {% for warehouse in unique_warehouses %}
                        <option value="{{ warehouse }}">{{ warehouse }}</option>
                    {% endfor %}
                </select>`;
            } else if (selectedOptionProps.hasInput) {
                newInputFieldHtml = `<input type="${selectedOptionProps.inputType}" name="query_${index}" id="searchQuery_${index}" class="form-control search-query" placeholder="Search..." value="${previousValue}">`;
            } else {
                newInputFieldHtml = `<input type="hidden" name="query_${index}" id="searchQuery_${index}" class="form-control search-query">`;
            }

            currentInputField.outerHTML = newInputFieldHtml;
            const updatedInputField = document.getElementById(`searchQuery_${index}`);
            if (selectedOptionProps.hasInput) updatedInputField.style.display = "block";
            else updatedInputField.style.display = "none";

            // Re-select if Warehouse and previousValue exists
            if (this.value === "Warehouse" && previousValue) {
                const trimmedPreviousValue = previousValue.trim();
                for (let i = 0; i < updatedInputField.options.length; i++) {
                    if (updatedInputField.options[i].value === trimmedPreviousValue) {
                        updatedInputField.options[i].selected = true;
                        break;
                    }
                }
            } else {
                updatedInputField.value = previousValue;
            }

            document.querySelectorAll('.filter-dropdown').forEach(otherDropdown => {
                updateDropdownOptions(otherDropdown, parseInt(otherDropdown.id.split('_')[1]));
            });

            if (this.value !== "No Condition" && index === (activeFilterRowCount - 1) && activeFilterRowCount < maxFilterRows) {
                createFilterRow(activeFilterRowCount);
                document.getElementById(`filter-row-${activeFilterRowCount - 1}`).style.display = "flex";
            } else if (this.value === "No Condition" && index < (activeFilterRowCount - 1)) {
                removeFilterRow(index + 1);
            }

            updateRemoveButtons();
            updateAddFilterButton();
        });

        removeBtn.addEventListener("click", function () {
            const idxToRemove = parseInt(this.dataset.index);
            removeFilterRow(idxToRemove);
            updateRemoveButtons();
            document.querySelectorAll('.filter-dropdown').forEach(otherDropdown => {
                updateDropdownOptions(otherDropdown, parseInt(otherDropdown.id.split('_')[1]));
            });
            updateAddFilterButton();
        });

        addBtn.addEventListener("click", function () {
            if (activeFilterRowCount < maxFilterRows) {
                createFilterRow(activeFilterRowCount);
                document.getElementById(`filter-row-${activeFilterRowCount - 1}`).style.display = "flex";
                updateAddFilterButton();
                updateRemoveButtons();
            }
        });

        updateRemoveButtons();
        updateAddFilterButton();
    }


    function updateDropdownOptions(dropdownElement, currentIndex) {
        const selectedValues = new Set();

        document.querySelectorAll('.filter-dropdown').forEach(otherDropdown => {
            if (otherDropdown.id !== dropdownElement.id && otherDropdown.value !== "No Condition") {
                selectedValues.add(otherDropdown.value);
            }
        });

        const currentSelectedValue = dropdownElement.value;

        dropdownElement.innerHTML = "";

        const noCond = document.createElement("option");
        noCond.value = "No Condition";
        noCond.textContent = "No Condition";
        dropdownElement.appendChild(noCond);

        filterOptions.forEach(option => {
            if (option !== "No Condition" && !selectedValues.has(option)) {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                dropdownElement.appendChild(opt);
            }
        });

        if ([...dropdownElement.options].some(opt => opt.value === currentSelectedValue)) {
            dropdownElement.value = currentSelectedValue;
        } else {
            dropdownElement.value = "No Condition";
        }
    }


    function removeFilterRow(startIdx) {
        for (let i = startIdx; i < activeFilterRowCount; i++) {
            const row = document.getElementById(`filter-row-${i}`);
            if (row) row.remove();
        }
        activeFilterRowCount = startIdx;
        updateRemoveButtons();
        updateAddFilterButton();
    }


    function updateRemoveButtons() {
        document.querySelectorAll(".remove-filter-btn").forEach(btn => btn.style.display = "none");

        if (activeFilterRowCount > 1) {
            for (let i = 1; i < activeFilterRowCount; i++) {
                const row = document.getElementById(`filter-row-${i}`);
                if (row) row.querySelector(".remove-filter-btn").style.display = "block";
            }
        }
    }

    function updateAddFilterButton() {
        document.querySelectorAll(".add-filter-btn").forEach(btn => btn.style.display = "none");

        if (activeFilterRowCount > 0 && activeFilterRowCount < maxFilterRows) {
            const lastIndex = activeFilterRowCount - 1;
            const lastDropdown = document.getElementById(`filterDropdown_${lastIndex}`);
            const lastAddBtn = document.getElementById(`filter-row-${lastIndex}`).querySelector(".add-filter-btn");
            if (lastDropdown && lastDropdown.value !== "No Condition") {
                lastAddBtn.style.display = "block";
            }
        }
    }


    document.addEventListener("DOMContentLoaded", function () {
        createFilterRow(0, "{{ filter_by_0|default:'No Condition' }}", "{{ query_0|default:'' }}");

        let initialActiveRows = 0;

        {% for i in "1234" %}
            {% with fb="filter_by_"|add:i|stringformat:"s" qy="query_"|add:i|stringformat:"s" %}
                {% if request.GET|get_item:fb %}
                    createFilterRow({{ i }}, "{{ request.GET|get_item:fb }}", "{{ request.GET|get_item:qy }}");
                    document.getElementById(`filter-row-{{ i }}`).style.display = "flex";
                    initialActiveRows = {{ i }} + 1;
                {% endif %}
            {% endwith %}
        {% endfor %}

        activeFilterRowCount = initialActiveRows > 0 ? initialActiveRows : 1;

        updateRemoveButtons();
        updateAddFilterButton();
    });
</script>

<style>
    .custom-close {
        position: absolute;
        top: 10px;
        right: 15px;
        border: none;
        background: none;
        color: red;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
    }
    .custom-close:hover {
        color: darkred;
    }
</style>

{% endblock %}
