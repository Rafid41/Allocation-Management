{% extends "base.html" %}
{% load static %}

{% block body_block %}
<div class="container mt-4">
    <a href="{% url 'Project_App_ProjectWiseBalance:project_list' %}" class="btn btn-outline-secondary back-btn">
        <i class="fa fa-arrow-left"></i> Back
    </a>
    <h3 class="mb-3 text-primary text-center">
        <i class="fa fa-folder-open"></i> <b>Project: <span class="text-success">{{ project.projectId }}</span></b>
    </h3>

    <form method="GET" class="mb-4" id="dynamicSearchForm">
        <div id="filterRowsContainer">
            <!-- Initial filter row will be added here by JavaScript -->
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                <button type="button" class="btn btn-secondary me-2" onclick="printResults()">Print</button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()">
                    <i class="fa fa-file-excel-o"></i> Export to Excel (.xlsx)
                </button>
            </div>
        </div>
    </form>

    <div id="printableDataTable" class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-bordered table-striped table-hover" id="projectDetailsTable">
            <thead class="thead-dark">
                <tr>
                    <th>Item Name</th>
                    <th>Warehouse</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Allocated</th>
                    <th>Carried</th>
                    <th>Uncarried</th>
                    <th>Balance with Uncarried</th>
                    <th>Entry Updated<br><span style="font-size: 0.75em; font-style: italic;">(dd/mm/yyyy)</span></th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for row in item_data %}
                <tr>
                    <td>{{ row.name }}</td>
                    <td>{{ row.warehouse }}</td>
                    <td>{{ row.unit }}</td>
                    <td>{{ row.quantity|floatformat:3 }}</td>
                    <td class="text-info font-weight-bold">{{ row.allocated|floatformat:3 }}</td>
                    <td class="text-success font-weight-bold">{{ row.carried|floatformat:3 }}</td>
                    <td class="text-warning font-weight-bold">{{ row.uncarried|floatformat:3 }}</td>
                    <td class="text-danger font-weight-bold">{{ row.balance|floatformat:3 }}</td>
                    <td>{{ row.created_at|date:"d/m/Y" }}</td>
                    <td class="remarks-cell position-relative">
                        <span id="remarks_display_{{ row.id }}" class="remarks-display">{{ row.remarks|default_if_none:"" }}</span>

                        {% if request.user.user_group.user_group_type == "Editor" %}
                        <button class="btn btn-sm btn-outline-primary update-btn"
                                onclick="showRemarksEdit({{ row.id }})">Update</button>

                        <div class="remarks-edit" id="edit_remarks_{{ row.id }}" style="display:none;">
                            <textarea id="remarks_text_{{ row.id }}" class="form-control form-control-sm" rows="2">{{ row.remarks|default_if_none:"" }}</textarea>
                            <button class="btn btn-sm btn-success mt-1" onclick="saveRemarks({{ row.id }})">
                                <i class="fa fa-check"></i> Save
                            </button>
                            <button class="btn btn-sm btn-secondary mt-1" onclick="cancelEdit({{ row.id }})">
                                <i class="fa fa-times"></i> Cancel
                            </button>
                        </div>
                        {% endif %}
                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-danger font-weight-bold">
                        No items found for this project.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
/* Update button only visible on hover */
.remarks-cell {
    position: relative;
}
.remarks-cell .update-btn {
    display: none;
    margin-left: 5px;
}
.remarks-cell:hover .update-btn {
    display: inline-block;
}
.remarks-cell .remarks-edit {
    margin-top: 5px;
}
.remarks-display {
    white-space: pre-wrap; /* keep line breaks */
}

@media print {
    body {
        margin: 0;
        padding: 0;
    }
    #printableDataTable table,
    #printableDataTable th,
    #printableDataTable td {
        border: 1px solid black !important;
    }
    #printableDataTable .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05) !important; /* Ensure stripe background prints */
    }
    #printableDataTable .table-hover tbody tr:hover {
        background-color: transparent !important; /* Disable hover effect on print */
    }
    /* Hide scrollbar for print */
    #printableDataTable {
        overflow: visible !important;
        max-height: none !important;
    }
    .remarks-cell .update-btn { /* Hide update button in remarks column for print */
        display: none !important;
    }
    .remarks-cell .remarks-edit { /* Hide edit box in remarks column for print */
        display: none !important;
    }
}
</style>

<script>
// ---- Get CSRF Token from Cookie ----
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

function showRemarksEdit(itemId) {
    const editBox = document.querySelector(`#edit_remarks_${itemId}`);
    const textarea = document.querySelector(`#remarks_text_${itemId}`);
    const displaySpan = document.querySelector(`#remarks_display_${itemId}`);

    if (!editBox) return;
    editBox.style.display = 'block';
    textarea.focus();
    textarea.selectionStart = textarea.value.length;

    // auto-resize textarea to fit content
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';

    // Hide display text
    displaySpan.style.display = 'none';
}

function cancelEdit(itemId) {
    const editBox = document.querySelector(`#edit_remarks_${itemId}`);
    const displaySpan = document.querySelector(`#remarks_display_${itemId}`);
    if (editBox) editBox.style.display = 'none';
    if (displaySpan) displaySpan.style.display = 'inline';
}

function saveRemarks(itemId) {
    const textarea = document.querySelector(`#remarks_text_${itemId}`);
    if (!textarea) return;
    const newRemarks = textarea.value;

    fetch(`/project/project_wise_balance/projects/project_details/update-remarks/${itemId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({remarks: newRemarks})
    }).then(res => {
        if (res.ok) {
            document.querySelector(`#edit_remarks_${itemId}`).style.display = "none";
            const displaySpan = document.querySelector(`#remarks_display_${itemId}`);
            displaySpan.textContent = newRemarks || "";
            displaySpan.style.display = "inline";
        } else {
            res.json().then(data => alert(data.error || "Failed to save remarks"));
        }
    }).catch(err => alert("Error: " + err));
}

// --- Filter Logic (unchanged) ---
const WAREHOUSE_CHOICES = JSON.parse('{{ warehouse_choices_json|escapejs }}');
const UNIT_CHOICES = JSON.parse('{{ unit_choices_json|escapejs }}');
const APPLIED_FILTERS = JSON.parse('{{ applied_filters_json|escapejs }}');

const ALL_FILTER_OPTIONS = [
  { value: "no_condition", text: "No Condition", type: "none" },
  { value: "item_name", text: "Item Name", type: "text" },
  { value: "warehouse", text: "Warehouse", type: "dropdown", choices: WAREHOUSE_CHOICES },
  { value: "entry_update_date", text: "Entry Update Date", type: "date" },
];

let filterRowCount = 0;
const maxFilterRows = 5; // As per instruction, 5 boxes
let suppressAutoAdd = false;
let lastRowManuallyCreated = false;

function getSelectedFilterValues() {
  const selected = [];
  document.querySelectorAll('.filter-select').forEach(sel => {
    if (sel.value !== "no_condition") selected.push(sel.value);
  });
  return selected;
}

function updateAvailableFilters() {
  const selected = getSelectedFilterValues();
  document.querySelectorAll('.filter-select').forEach(sel => {
    const curVal = sel.value;
    sel.innerHTML = "";
    ALL_FILTER_OPTIONS.forEach(opt => {
      if (opt.value === "no_condition" || opt.value === curVal || !selected.includes(opt.value)) {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.text;
        sel.appendChild(o);
      }
    });
    sel.value = curVal;
  });
}

function updateFilterRow(select) {
  const row = select.closest(".filter-row");
  const type = select.value;
  const input = row.querySelector(".input-container");
  input.innerHTML = "";
  const opt = ALL_FILTER_OPTIONS.find(o => o.value === type);
  const idx = row.dataset.filterIndex;

  if (opt && opt.type === "text") {
    input.innerHTML = `<input type="text" name="filter_value_${idx}" class="form-control" placeholder="${opt.text}">`;
  } else if (opt && opt.type === "date") {
    input.innerHTML = `
      <input type="date" name="filter_value_${idx}" class="form-control mb-2">
    `;
  } else if (opt && opt.type === "dropdown") {
    let opts = "";
    opt.choices.forEach(c => { opts += `<option value="${c[0]}">${c[1]}</option>`; });
    input.innerHTML = `<select name="filter_value_${idx}" class="form-select">${opts}</select>`;
  }

  updateAvailableFilters();

  const lastRow = document.querySelector(".filter-row:last-child");
  const prevVal = select.dataset.prevValue ?? "no_condition";

  if (
    !suppressAutoAdd &&
    lastRow === row &&
    type !== "no_condition" &&
    prevVal === "no_condition" &&
    filterRowCount < maxFilterRows
  ) {
    addFilterRow();
  }

  select.dataset.prevValue = type;
  updateAddRemoveButtonVisibility();
}

function addFilterRow(initialType = "no_condition", initialValue = "", initialDateStatus = "") {
  if (filterRowCount >= maxFilterRows) return;
  filterRowCount++;
  const idx = filterRowCount;
  const cont = document.getElementById("filterRowsContainer");

  const row = document.createElement("div");
  row.classList.add("row", "g-3", "mb-3", "filter-row");
  row.dataset.filterIndex = idx;
  row.innerHTML = `
    <div class="col-md-4">
      <select name="filter_type_${idx}" class="form-select filter-select"></select>
    </div>
    <div class="col-md-6 input-container"></div>
    <div class="col-md-2 d-flex justify-content-end">
      <button type="button" class="btn btn-danger remove-filter-row me-1" onclick="removeFilterRow(this)">
        <i class="fa fa-times"></i>
      </button>
      <button type="button" class="btn btn-info add-filter-row-btn" style="display:none;">
        <i class="fa fa-plus"></i> Add
      </button>
    </div>
  `;
  cont.appendChild(row);

  const select = row.querySelector(".filter-select");
  updateAvailableFilters();
  select.value = initialType;
  select.addEventListener("focus", () => select.dataset.prevValue = select.value);
  select.addEventListener("pointerdown", () => select.dataset.prevValue = select.value);
  select.addEventListener("change", () => updateFilterRow(select));
  updateFilterRow(select); // Call once to set up initial input field

  // Set initial value for the input field
  const inputElement = row.querySelector(`[name="filter_value_${idx}"]`);
  if (inputElement) {
    inputElement.value = initialValue;
  }
  // Set initial value for date_status dropdown if it exists
  const dateStatusElement = row.querySelector(`[name="date_status_${idx}"]`);
  if (dateStatusElement && initialDateStatus) {
    dateStatusElement.value = initialDateStatus;
  }

  row.querySelector(".add-filter-row-btn").addEventListener("click", () => addFilterRow());
  updateAddRemoveButtonVisibility();
}

function removeFilterRow(btn) {
  const row = btn.closest(".filter-row");
  const all = Array.from(document.querySelectorAll(".filter-row"));
  const isLast = all.length && all[all.length - 1] === row;
  row.remove();
  filterRowCount = document.querySelectorAll(".filter-row").length;

  lastRowManuallyCreated = isLast;
  updateAvailableFilters();
  updateAddRemoveButtonVisibility();
}

function updateAddRemoveButtonVisibility() {
  const rows = document.querySelectorAll(".filter-row");
  rows.forEach((row, i) => {
    const rm = row.querySelector(".remove-filter-row");
    const add = row.querySelector(".add-filter-row-btn");
    const sel = row.querySelector(".filter-select");

    rm.style.display = (rows.length > 1) ? "inline-block" : "none";
    add.style.display = "none";

    if (i === rows.length - 1) {
      if (lastRowManuallyCreated) {
        add.style.display = (filterRowCount < maxFilterRows) ? "inline-block" : "none";
      } else if (sel.value === "no_condition" && filterRowCount < maxFilterRows) {
        add.style.display = "inline-block";
      }
    }
  });
}

// --- Initialization
document.addEventListener("DOMContentLoaded", () => {
  suppressAutoAdd = true;
  if (APPLIED_FILTERS.length) {
    APPLIED_FILTERS.forEach(f => addFilterRow(f.type, f.value, f.date_status));
    if (filterRowCount < maxFilterRows) addFilterRow();
  } else {
    addFilterRow();
  }

  document.querySelectorAll(".filter-select").forEach(sel => sel.dataset.prevValue = sel.value);
  suppressAutoAdd = false;
  updateAddRemoveButtonVisibility();
  updateAvailableFilters();
});

function printResults() {
    var originalContents = document.body.innerHTML;
    var printContentsElement = document.getElementById('printableDataTable');

    // Clone the printable area to manipulate it without affecting the live DOM
    var clonedPrintContents = printContentsElement.cloneNode(true);

    // Find and remove update buttons and edit boxes from the cloned content
    clonedPrintContents.querySelectorAll('.update-btn, .remarks-edit').forEach(el => {
        el.remove();
    });

    document.body.innerHTML = clonedPrintContents.innerHTML;
    window.print();
    document.body.innerHTML = originalContents;
    location.reload(); // Reload to restore full page functionality and event listeners
}

/* -------------------------
   Export to .xlsx:
   - prefer ExcelJS if loaded (reliable bold headers)
   - fallback to SheetJS (XLSX) using rich-text trick
   - only export .remarks-display text
   - numeric columns exported as numbers
------------------------- */
async function exportToExcel() {
    try {
        const table = document.getElementById('projectDetailsTable');
        if (!table) return alert('Table not found');

        // Helper to read rows into a simple array-of-arrays (aoa)
        const buildAOA = () => {
            const aoa = [];
            const headers = [
                'Item Name',
                'Warehouse',
                'Unit',
                'Quantity',
                'Allocated',
                'Carried',
                'Uncarried',
                'Balance with Uncarried',
                'Entry Updated (dd/mm/yyyy)', // Corrected header text
                'Remarks'
            ];
            aoa.push(headers);

            const tbody = table.querySelector('tbody');
            const trs = Array.from(tbody.querySelectorAll('tr'));
            trs.forEach(tr => {
                const tds = Array.from(tr.querySelectorAll('td'));
                if (!tds || tds.length === 0) return;

                // Extract visible text values; for remarks prefer .remarks-display
                const itemName = tds[0].innerText.trim();
                const warehouse = tds[1].innerText.trim();
                const unit = tds[2].innerText.trim();

                const parseNum = txt => {
                    if (!txt) return null;
                    const n = parseFloat(txt.replace(/,/g, ''));
                    return Number.isFinite(n) ? n : null;
                };

                const quantity = parseNum(tds[3].innerText.trim());
                const allocated = parseNum(tds[4].innerText.trim());
                const carried = parseNum(tds[5].innerText.trim());
                const uncarried = parseNum(tds[6].innerText.trim());
                const balance = parseNum(tds[7].innerText.trim());
                const entryUpdated = tds[8].innerText.trim();

                const remarksEl = tds[9].querySelector('.remarks-display');
                const remarks = remarksEl ? remarksEl.innerText.trim() : tds[9].innerText.trim();

                aoa.push([
                    itemName || '',
                    warehouse || '',
                    unit || '',
                    quantity !== null ? quantity : (tds[3].innerText.trim() || ''),
                    allocated !== null ? allocated : (tds[4].innerText.trim() || ''),
                    carried !== null ? carried : (tds[5].innerText.trim() || ''),
                    uncarried !== null ? uncarried : (tds[6].innerText.trim() || ''),
                    balance !== null ? balance : (tds[7].innerText.trim() || ''),
                    entryUpdated || '',
                    remarks || ''
                ]);
            });

            return aoa;
        };

        // Prefer ExcelJS (recommended) if available
        if (typeof ExcelJS !== 'undefined') {
            const aoa = buildAOA();
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('Project Details');

            // Header row (bold)
            const headers = aoa[0];
            const headerRow = ws.addRow(headers);
            headerRow.eachCell(cell => {
                cell.font = { bold: true };
                cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
            });
            ws.views = [{ state: 'frozen', ySplit: 1 }];

            // column widths
            ws.columns = [
                { key: 'name', width: 30 },
                { key: 'warehouse', width: 18 },
                { key: 'unit', width: 10 },
                { key: 'quantity', width: 12 },
                { key: 'allocated', width: 12 },
                { key: 'carried', width: 12 },
                { key: 'uncarried', width: 12 },
                { key: 'balance', width: 16 },
                { key: 'entry_updated', width: 18 },
                { key: 'remarks', width: 40 }
            ];

            // Add data rows
            for (let i = 1; i < aoa.length; i++) {
                const row = aoa[i];
                const newRow = ws.addRow(row);
                // apply numeric formats for quantity/allocated/carried/uncarried/balance (cols 4..8)
                const numFmt = '#,##0.000';
                [4,5,6,7,8].forEach(ci => {
                    const cell = newRow.getCell(ci);
                    if (typeof cell.value === 'number') {
                        cell.numFmt = numFmt;
                        cell.alignment = { vertical: 'top', horizontal: 'right' };
                    } else {
                        cell.alignment = { vertical: 'top', horizontal: 'left' };
                    }
                });
                // remarks wrap
                newRow.getCell(10).alignment = { wrapText: true, vertical: 'top' };
            }

            // autofilter
            ws.autoFilter = {
                from: { row: 1, column: 1 },
                to: { row: 1 + aoa.length - 1, column: aoa[0].length }
            };

            // export
            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const safeProjectId = String('{{ project.projectId }}').replace(/[^a-zA-Z0-9-_ ]/g, '');
            const filename = `ProjectWiseBalance Details for Project-${safeProjectId}.xlsx`;

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            return;
        }

        // Fallback: use SheetJS (XLSX) if available
        if (typeof XLSX !== 'undefined') {
            const aoa = buildAOA();
            const ws = XLSX.utils.aoa_to_sheet(aoa);

            // Apply borders to all cells
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (!ws[cell_ref]) continue;
                    if (!ws[cell_ref].s) ws[cell_ref].s = {};
                    ws[cell_ref].s.border = {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    };
                }
            }

            // Try to force bold headers via rich text runs (works in many OSS builds)
            const headerLen = aoa[0].length;
            for (let c = 0; c < headerLen; c++) {
                const addr = XLSX.utils.encode_cell({ r: 0, c: c });
                // set rich text run
                ws[addr] = {
                    t: 's',
                    v: aoa[0][c],
                    r: [{ t: 's', v: aoa[0][c], s: { bold: true } }]
                };
            }

            // set column widths (wch)
            ws['!cols'] = [
                { wch: 30 },
                { wch: 12 },
                { wch: 5 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 },
                { wch: 16 },
                { wch: 25 },
                { wch: 40 },
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Project Details');

            const safeProjectId = String('{{ project.projectId }}').replace(/[^a-zA-Z0-9-_ ]/g, '');
            const filename = `ProjectWiseBalance Details for Project-${safeProjectId}.xlsx`;

            XLSX.writeFile(wb, filename);
            return;
        }

        // If neither library available
        alert('No Excel library found. Please include ExcelJS (preferred) or SheetJS (XLSX) in base.html.');
    } catch (err) {
        console.error('Export error', err);
        alert('Export failed: ' + (err && err.message ? err.message : err));
    }
}
</script>

{% endblock %}
