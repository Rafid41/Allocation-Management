{% extends "base.html" %}
{% load static %}

{% block body_block %}
<div class="container mt-4">
    <a href="{% url 'Project_App_ProjectWiseBalance:project_list' %}" class="btn btn-outline-secondary back-btn">
        <i class="fa fa-arrow-left"></i> Back
    </a>
    <h3 class="mb-3 text-primary">
        <i class="fa fa-folder-open"></i> Project: {{ project.projectId }}
    </h3>

    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-bordered table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Item Name</th>
                    <th>Warehouse</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Allocated</th>
                    <th>Carried</th>
                    <th>Uncarried</th>
                    <th>Balance with Uncarried</th>
                    <th>Entry Updated</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for row in item_data %}
                <tr>
                    <td>{{ row.name }}</td>
                    <td>{{ row.warehouse }}</td>
                    <td>{{ row.unit }}</td>
                    <td>{{ row.quantity|floatformat:3 }}</td>
                    <td class="text-info font-weight-bold">{{ row.allocated|floatformat:3 }}</td>
                    <td class="text-success font-weight-bold">{{ row.carried|floatformat:3 }}</td>
                    <td class="text-warning font-weight-bold">{{ row.uncarried|floatformat:3 }}</td>
                    <td class="text-danger font-weight-bold">{{ row.balance|floatformat:3 }}</td>
                    <td>{{ row.created_at|date:"d/m/Y" }}</td>
                    <td class="remarks-cell position-relative">
                        <span id="remarks_display_{{ row.id }}" class="remarks-display">{{ row.remarks|default_if_none:"" }}</span>


                        {% if request.user.user_group.user_group_type == "Editor" %}
                        <button class="btn btn-sm btn-outline-primary update-btn"
                                onclick="showRemarksEdit({{ row.id }})">Update</button>

                        <div class="remarks-edit" id="edit_remarks_{{ row.id }}" style="display:none;">
                            <textarea id="remarks_text_{{ row.id }}" class="form-control form-control-sm" rows="2">{{ row.remarks|default_if_none:"" }}</textarea>
                            <button class="btn btn-sm btn-success mt-1" onclick="saveRemarks({{ row.id }})">
                                <i class="fa fa-check"></i> Save
                            </button>
                            <button class="btn btn-sm btn-secondary mt-1" onclick="cancelEdit({{ row.id }})">
                                <i class="fa fa-times"></i> Cancel
                            </button>
                        </div>
                        {% endif %}
                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-danger font-weight-bold">
                        No items found for this project.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
/* Update button only visible on hover */
.remarks-cell {
    position: relative;
}
.remarks-cell .update-btn {
    display: none;
    margin-left: 5px;
}
.remarks-cell:hover .update-btn {
    display: inline-block;
}
.remarks-cell .remarks-edit {
    margin-top: 5px;
}
.remarks-display {
    white-space: pre-wrap; /* keep line breaks */
}

</style>

<script>
// ---- Get CSRF Token from Cookie ----
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

function showRemarksEdit(itemId) {
    const editBox = document.querySelector(`#edit_remarks_${itemId}`);
    const textarea = document.querySelector(`#remarks_text_${itemId}`);
    const displaySpan = document.querySelector(`#remarks_display_${itemId}`);

    editBox.style.display = 'block';
    textarea.focus();
    textarea.selectionStart = textarea.value.length;

    // auto-resize textarea to fit content
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';

    // Hide display text
    displaySpan.style.display = 'none';
}

function cancelEdit(itemId) {
    document.querySelector(`#edit_remarks_${itemId}`).style.display = 'none';
    document.querySelector(`#remarks_display_${itemId}`).style.display = 'inline';
}

function saveRemarks(itemId) {
    const textarea = document.querySelector(`#remarks_text_${itemId}`);
    const newRemarks = textarea.value;

    fetch(`/project/project_wise_balance/projects/project_details/update-remarks/${itemId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({remarks: newRemarks})
    }).then(res => {
        if (res.ok) {
            document.querySelector(`#edit_remarks_${itemId}`).style.display = "none";
            const displaySpan = document.querySelector(`#remarks_display_${itemId}`);
            displaySpan.textContent = newRemarks || "-";
            displaySpan.style.display = "inline";
        } else {
            res.json().then(data => alert(data.error || "Failed"));
        }
    }).catch(err => alert("Error: " + err));
}
</script>


{% endblock %}
