{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title_block %} Project History {% endblock %}

{% block body_block %}
<a href="{% url 'Project_App_Home:project_home_page' %}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Back
</a>

<div class="container mt-4">
    <h2 class="text-center mb-3"><b>Project History</b></h2>

    <form method="GET" class="mb-4" id="dynamicSearchForm">
        <div id="filterRowsContainer">
            <!-- JS will inject filter rows -->
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                <button type="button" class="btn btn-secondary me-2" onclick="printResults()">Print</button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()">
                    <i class="fa fa-file-excel-o"></i> Export to Excel (.xlsx)
                </button>
            </div>
        </div>
    </form>

    <!-- Printable Table -->
    <div id="printableArea" class="table-responsive">
        <table class="table table-bordered table-striped table-hover text-center" id="historyTable">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Allocation No</th>
                    <th>PBS</th>
                    <th>Project</th>
                    <th>Item</th>
                    <th>Unit</th>
                    <th>Warehouse</th>
                    <th>Quantity</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th>
                        Carry from Warehouse<br>
                        <span style="font-size: 0.75em; font-style: italic;">(dd/mm/yyyy)</span>
                    </th>
                    <th>Comments</th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                         <tr class="{% if item.remarks_status == 'Deleted' or item.status == 'Cancelled' %}table-danger{% elif item.remarks_status == 'Added' and item.status == 'Modified' %}table-light-green{% endif %}">
                            <td>{{ item.allocation_no }}</td>
                            <td>{{ item.pbs }}</td>
                            <td>{{ item.project }}</td>
                            <td>{{ item.item }}</td>
                            <td>{{ item.unit_of_item }}</td>
                            <td>{{ item.warehouse }}</td>
                            <td>{{ item.quantity }}</td>
                            <td class="{% if item.status == 'Allocated' %}text-success{% elif item.status == 'Cancelled' %}text-danger{% elif item.status == 'Modified' %}text-primary{% endif %}">
                                <strong>{{ item.status }}</strong>
                            </td>
                            <td>{{ item.remarks|safe }}</td>

                            <!-- Carry From Warehouse -->
                            <td class="date-cell">
                                {% if item.carry_from_warehouse == "N/A" %}
                                    <span class="text-danger"><b>N/A</b></span><br>
                                {% elif item.carry_from_warehouse %}
                                    {% with day=item.carry_from_warehouse|slice:"8:10" month=item.carry_from_warehouse|slice:"5:7" year=item.carry_from_warehouse|slice:"0:4" %}
                                        {{ day }}/{{ month }}/{{ year }}
                                    {% endwith %}
                                {% endif %}

                                {% if can_edit_carry and item.status != 'Cancelled' and item.remarks_status != 'Deleted' %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn" onclick="showInput('{{ item.id }}', 'carry')">Update</button>
                                    <button class="btn btn-sm btn-outline-danger mt-1 update-btn" data-toggle="modal" data-target="#resetModal" onclick="setResetTarget('{{ item.id }}', 'carry')">Reset</button>

                                    <div id="input_carry_{{ item.id }}" style="display: none;" class="mt-1">
                                        <input type="date" id="date_carry_{{ item.id }}" class="form-control form-control-sm"
                                            {% if item.carry_from_warehouse and item.carry_from_warehouse != "N/A" %}
                                                value="{{ item.carry_from_warehouse }}"
                                            {% endif %}>
                                        <button class="btn btn-sm btn-success mt-1" onclick="submitDate('{{ item.id }}', 'carry')">Save</button>
                                    </div>
                                {% endif %}
                            </td>

                            <!-- Comments -->
                            <td class="comments-cell text-start">
                                {% if item.comments %}
                                    {{ item.comments|linebreaksbr }}<br>
                                {% endif %}

                                {% if can_edit_comments %}
                                    <button class="btn btn-sm btn-outline-primary mt-1 update-btn" onclick="showCommentInput('{{ item.id }}')">Update</button>
                                    <div id="input_comments_{{ item.id }}" style="display: none;" class="mt-1">
                                        <textarea id="text_comments_{{ item.id }}" class="form-control form-control-sm" rows="3">{{ item.comments|default_if_none:"" }}</textarea>
                                        <button class="btn btn-sm btn-success mt-1" onclick="submitComment('{{ item.id }}')">Save</button>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" role="dialog" aria-labelledby="resetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg rounded">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="resetModalLabel">
          <i class="fa fa-exclamation-triangle"></i> Confirm Reset
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to reset this date? <b>This action cannot be undone.</b>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn">
          <i class="fa fa-check"></i> Yes, Reset
        </button>
      </div>
    </div>
  </div>
</div>

<style>
    .table {
        font-size: 16px;
        text-align: center;
    }
    .date-cell button.update-btn { display: none; }
    .date-cell:hover button.update-btn { display: inline-block; }

    .comments-cell button.update-btn { display: none; }
    .comments-cell:hover button.update-btn { display: inline-block; }

    @media print {
        body * { visibility: hidden; }
        #printableArea, #printableArea * { visibility: visible; }
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }

    /* Custom Deeper Colors */
    .table-light-green, .table-light-green > th, .table-light-green > td {
        background-color: #84eab3 !important;  /* soft light green */
    }
</style>

<script>
const ALL_FILTER_OPTIONS = [
  { value: "no_condition", text: "No Condition", type: "none" },
  { value: "allocation_no", text: "Allocation No", type: "text" },
  { value: "pbs", text: "PBS", type: "text" },
  { value: "project", text: "Project", type: "text" },
  { value: "item", text: "Item", type: "text" },
  { value: "warehouse", text: "Warehouse", type: "text" },
  { value: "status", text: "Status", type: "status_dropdown" },
  { value: "carry_from_warehouse_date", text: "Carry from Warehouse Date", type: "date" }
];

const STATUS_CHOICES = JSON.parse('{{ status_choices_json|escapejs }}');
let filterRowCount = 0;
const maxFilterRows = 9;
let suppressAutoAdd = false;
let lastRowManuallyCreated = false;

function getSelectedFilterValues() {
  const selected = [];
  document.querySelectorAll('.filter-select').forEach(sel => {
    if (sel.value !== "no_condition") selected.push(sel.value);
  });
  return selected;
}

function updateAvailableFilters() {
  const selected = getSelectedFilterValues();
  document.querySelectorAll('.filter-select').forEach(sel => {
    const curVal = sel.value;
    sel.innerHTML = "";
    ALL_FILTER_OPTIONS.forEach(opt => {
      if (opt.value === "no_condition" || opt.value === curVal || !selected.includes(opt.value)) {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.text;
        sel.appendChild(o);
      }
    });
    sel.value = curVal;
  });
}

function updateFilterRow(select) {
  const row = select.closest(".filter-row");
  const type = select.value;
  const input = row.querySelector(".input-container");
  input.innerHTML = "";
  const opt = ALL_FILTER_OPTIONS.find(o => o.value === type);
  const idx = row.dataset.filterIndex;

  if (opt && opt.type === "text") {
    input.innerHTML = `<input type="text" name="filter_value_${idx}" class="form-control" placeholder="${opt.text}">`;
  } else if (opt && opt.type === "date") {
    // carry_from_warehouse_date gets the extra dropdown
    input.innerHTML = `
      <input type="date" name="filter_value_${idx}" class="form-control mb-2">
      <select name="date_status_${idx}" class="form-select">
        <option value="all">Show All Data</option>
        <option value="empty">Show Empty Cells</option>
      </select>
    `;
  } else if (opt && opt.type === "status_dropdown") {
    let opts = "";
    STATUS_CHOICES.forEach(c => { opts += `<option value="${c[0]}">${c[1]}</option>`; });
    input.innerHTML = `<select name="filter_value_${idx}" class="form-select">${opts}</select>`;
  }

  updateAvailableFilters();

  const lastRow = document.querySelector(".filter-row:last-child");
  const prevVal = select.dataset.prevValue ?? "no_condition";

  // Only auto-add when last row changed from no_condition -> something
  if (
    !suppressAutoAdd &&
    lastRow === row &&
    type !== "no_condition" &&
    prevVal === "no_condition" &&
    filterRowCount < maxFilterRows
  ) {
    addFilterRow();
  }

  select.dataset.prevValue = type;
  updateAddRemoveButtonVisibility();
}

function addFilterRow(initial = "no_condition", val = "") {
  if (filterRowCount >= maxFilterRows) return;
  filterRowCount++;
  const idx = filterRowCount;
  const cont = document.getElementById("filterRowsContainer");

  const row = document.createElement("div");
  row.classList.add("row", "g-3", "mb-3", "filter-row");
  row.dataset.filterIndex = idx;
  row.innerHTML = `
    <div class="col-md-4">
      <select name="filter_type_${idx}" class="form-select filter-select"></select>
    </div>
    <div class="col-md-6 input-container"></div>
    <div class="col-md-2 d-flex justify-content-end">
      <button type="button" class="btn btn-danger remove-filter-row me-1" onclick="removeFilterRow(this)">
        <i class="fa fa-times"></i>
      </button>
      <button type="button" class="btn btn-info add-filter-row-btn" style="display:none;">
        <i class="fa fa-plus"></i> Add
      </button>
    </div>
  `;
  cont.appendChild(row);

  const select = row.querySelector(".filter-select");
  updateAvailableFilters();
  select.value = initial;
  select.addEventListener("focus", () => select.dataset.prevValue = select.value);
  select.addEventListener("pointerdown", () => select.dataset.prevValue = select.value);
  select.addEventListener("change", () => updateFilterRow(select));
  updateFilterRow(select);

  if (val) {
    const input = row.querySelector(`[name="filter_value_${idx}"]`);
    if (input) input.value = val;
    const dsElem = row.querySelector(`[name="date_status_${idx}"]`);
    if (dsElem) {
      // If a date_status param exists in URL, previously we set it in init block
    }
  }

  row.querySelector(".add-filter-row-btn").addEventListener("click", () => {
    lastRowManuallyCreated = true;
    addFilterRow();
  });
  updateAddRemoveButtonVisibility();
}

function removeFilterRow(btn) {
  const row = btn.closest(".filter-row");
  const all = Array.from(document.querySelectorAll(".filter-row"));
  const isLast = all.length && all[all.length - 1] === row;
  row.remove();
  filterRowCount = document.querySelectorAll(".filter-row").length;

  // If last was deleted â†’ next last gets manual Add visibility
  lastRowManuallyCreated = isLast;
  updateAvailableFilters();
  updateAddRemoveButtonVisibility();
}

function updateAddRemoveButtonVisibility() {
  const rows = document.querySelectorAll(".filter-row");
  rows.forEach((row, i) => {
    const rm = row.querySelector(".remove-filter-row");
    const add = row.querySelector(".add-filter-row-btn");
    const sel = row.querySelector(".filter-select");

    rm.style.display = (rows.length > 1) ? "inline-block" : "none";
    add.style.display = "none";

    // Show add button logic
    if (i === rows.length - 1) {
      if (lastRowManuallyCreated) {
        add.style.display = (filterRowCount < maxFilterRows) ? "inline-block" : "none";
      } else if (sel.value === "no_condition" && filterRowCount < maxFilterRows) {
        add.style.display = "inline-block";
      }
    }
  });
}

// Initialization: read URL params and pre-populate rows when present
document.addEventListener("DOMContentLoaded", () => {
  suppressAutoAdd = true;
  const urlParams = new URLSearchParams(window.location.search);
  const existing = [];
  for (let i = 1; i <= maxFilterRows; i++) {
    const ft = urlParams.get(`filter_type_${i}`);
    const fv = urlParams.get(`filter_value_${i}`);
    const ds = urlParams.get(`date_status_${i}`);
    if (ft && ft !== "no_condition") existing.push({ type: ft, value: fv || "", date_status: ds || "all" });
  }

  if (existing.length) {
    existing.forEach((f, idx) => {
      addFilterRow(f.type, f.value);
      // Only set date_status for carry_from_warehouse_date
      const i = idx + 1;
      if (f.type === "carry_from_warehouse_date") {
        const dsElem = document.querySelector(`[name="date_status_${i}"]`);
        if (dsElem && f.date_status) dsElem.value = f.date_status;
      }
    });
    if (filterRowCount < maxFilterRows) addFilterRow();
  } else {
    addFilterRow();
  }

  document.querySelectorAll(".filter-select").forEach(sel => sel.dataset.prevValue = sel.value);
  suppressAutoAdd = false;
  updateAddRemoveButtonVisibility();
  updateAvailableFilters();
});

function printResults() { window.print(); }

function showInput(id, field) {
    document.getElementById(`input_${field}_${id}`).style.display = 'block';
}

function submitDate(id, field) {
    const datetime = document.getElementById(`date_${field}_${id}`).value;
    if (!datetime) return alert("Please select a date.");

    fetch(`/project/project_history/update-date/${id}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": '{{ csrf_token }}',
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ field: field, date: datetime })
    }).then(res => {
        if (res.ok) location.reload();
        else res.json().then(data => alert(data.error || "Failed"));
    });
}

function showCommentInput(id) {
    const container = document.getElementById(`input_comments_${id}`);
    container.style.display = 'block';
    const textarea = document.getElementById(`text_comments_${id}`);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
}

function submitComment(id) {
    const comment = document.getElementById(`text_comments_${id}`).value;

    fetch(`/project/project_history/update-date/${id}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": '{{ csrf_token }}',
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ field: "comments", text: comment })
    }).then(res => {
        if (res.ok) location.reload();
        else res.json().then(data => alert(data.error || "Failed"));
    });
}

let resetTargetId = null;
let resetTargetField = null;
function setResetTarget(id, field) {
    resetTargetId = id;
    resetTargetField = field;
}
document.getElementById("confirmResetBtn").addEventListener("click", function() {
    if (!resetTargetId || !resetTargetField) return;

    fetch(`/project/project_history/update-date/${resetTargetId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": '{{ csrf_token }}',
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ field: resetTargetField, reset: true })
    }).then(res => {
        if (res.ok) location.reload();
        else res.json().then(data => alert(data.error || "Failed"));
    });

    // Close modal (Bootstrap 4)
    $('#resetModal').modal('hide');
});

function exportToExcel() {
    try {
        if (typeof XLSX === 'undefined') {
            alert('SheetJS (XLSX) library not loaded. Make sure you included it in base.html.');
            return;
        }

        const originalTable = document.getElementById('historyTable');
        
        // Create a new table in memory
        const newTable = document.createElement('table');
        
        // Create and append the header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            'Allocation No',
            'PBS',
            'Project',
            'Item',
            'Unit',
            'Warehouse',
            'Quantity',
            'Status',
            'Remarks',
            'Carry from Warehouse (dd/mm/yyyy)',
            'Comments'
        ];
        headers.forEach(headerText => {
            const newTh = document.createElement('th');
            const b = document.createElement('b');
            b.innerText = headerText;
            newTh.appendChild(b);
            headerRow.appendChild(newTh);
        });
        thead.appendChild(headerRow);
        newTable.appendChild(thead);

        // Clone and append the body, cleaning up interactive elements
        const tbody = document.createElement('tbody');
        originalTable.querySelectorAll('tbody tr').forEach(originalTr => {
            const newTr = document.createElement('tr');
            originalTr.querySelectorAll('td').forEach((originalTd, index) => {
                const newTd = document.createElement('td');
                if (index === 9) { // Carry from Warehouse column
                    // Extract only the date text, ignoring buttons and input divs
                    const dateText = originalTd.querySelector('.date-cell') ? originalTd.querySelector('.date-cell').innerText.split('\n')[0].trim() : originalTd.innerText.trim();
                    newTd.innerText = dateText;
                } else if (index === 10) { // Comments column
                    // Extract only the comments text, ignoring buttons and input divs
                    const commentsText = originalTd.querySelector('.comments-cell') ? originalTd.querySelector('.comments-cell').innerText.split('\n')[0].trim() : originalTd.innerText.trim();
                    newTd.innerText = commentsText;
                } else {
                    newTd.innerText = originalTd.innerText.trim();
                }
                newTr.appendChild(newTd);
            });
            tbody.appendChild(newTr);
        });
        newTable.appendChild(tbody);

        // Convert the new table to a worksheet
        const ws = XLSX.utils.table_to_sheet(newTable);

        // Apply borders to all cells
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = { c: C, r: R };
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                if (!ws[cell_ref]) continue;
                if (!ws[cell_ref].s) ws[cell_ref].s = {};
                ws[cell_ref].s.border = {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                };
            }
        }

        // Set column widths
        ws['!cols'] = [
            { wch: 11 }, // Allocation No
            { wch: 10 }, // PBS
            { wch: 15 }, // Project
            { wch: 25 }, // Item
            { wch: 5 },  // Unit
            { wch: 12 }, // Warehouse
            { wch: 12 }, // Quantity
            { wch: 15 }, // Status
            { wch: 30 }, // Remarks
            { wch: 20 }, // Carry from Warehouse
            { wch: 40 }  // Comments
        ];

        // Make workbook and append sheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Project History');

        const filename = `Project History.xlsx`;

        XLSX.writeFile(wb, filename);
    } catch (err) {
        console.error(err);
        alert('Export failed: ' + (err && err.message ? err.message : err));
    }
}
</script>
{% endblock %}
