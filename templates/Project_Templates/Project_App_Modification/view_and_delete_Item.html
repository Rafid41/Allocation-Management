{% extends 'base.html' %}
{% load static %}

{% block title_block %} View and Delete Project Item {% endblock %}

{% block body_block %}
{% if messages %}
    {% for message in messages %}
    <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
        <i class="fa {% if message.tags == 'success' %}fa-check-circle text-success{% else %}fa-exclamation-circle text-danger{% endif %}"></i>
        {{ message }}
        <button type="button" class="custom-close" data-bs-dismiss="alert">X</button>
    </div>
    {% endfor %}
{% endif %}

<a href="{% url 'Project_App_Modification:modification_options' allocation_no_obj.pk  %}" class="btn btn-outline-secondary mb-3">
    <i class="fa fa-arrow-left"></i> Back
</a>

<h2 class="text-center text-primary">Allocated Items for ID: <b class="text-danger">{{ allocation_no_obj }}</b></h2>

    <form method="GET" class="mb-4" id="dynamicSearchForm">
        <div id="filterRowsContainer" class="container">
            <!-- Initial filter row will be added here by JavaScript -->
        </div>
        <div class="row mt-3 container">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">Search</button>
            </div>
        </div>
    </form>

<div class="container mt-3">
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="thead-dark sticky-top">
                <tr>
                    <th>Project</th>
                    <th>Item</th>
                    <th>Warehouse</th>
                    <th>PBS</th>
                    <th>Quantity</th>
                    {% comment %} <th>Unit Price</th> {% endcomment %}
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% if allocations %}
                    {% for allocation in allocations %}
                    <tr class="allocation-row">
                        <td>{{ allocation.project.projectId }}</td>
                        <td>{{ allocation.item.name }}</td>
                        <td>{{ allocation.warehouse }}</td>
                        <td>{{ allocation.pbs }}</td>
                        <td>{{ allocation.quantity }}</td>
                        {% comment %} <td>à§³ {{ allocation.price }}</td> {% endcomment %}
                        <td class="text-center">
                            <div class="delete-wrapper">
                                <button class="btn btn-sm btn-danger delete-btn" data-toggle="modal" data-target="#deleteModal{{ allocation.id }}">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </div>

                            <!-- Delete confirmation modal -->
                            <div class="modal fade" id="deleteModal{{ allocation.id }}" tabindex="-1" role="dialog">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title text-danger">Delete Entry</h5>
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure you want to delete this item?
                                        </div>
                                        <div class="modal-footer">
                                            <form method="POST" action="{% url 'Project_App_Modification:delete_final_allocation_entry' allocation.id %}">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger">Yes, Delete</button>
                                            </form>
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-danger">No allocations available.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .custom-close {
        position: absolute;
        top: 10px;
        right: 15px;
        border: none;
        background: none;
        color: red;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
    }

    .custom-close:hover {
        color: darkred;
    }

    /* Hide delete button initially */
    .delete-wrapper .delete-btn {
        display: none;
    }

    /* Show on row hover */
    tr:hover .delete-wrapper .delete-btn {
        display: inline-block;
    }
</style>

<script>
    const ALL_FILTER_OPTIONS = [
      { value: "no_condition", text: "No Condition", type: "none" },
      { value: "pbs", text: "PBS", type: "text" },
      { value: "project", text: "Project", type: "text" },
      { value: "item", text: "Item", type: "text" },
      { value: "warehouse", text: "Warehouse", type: "warehouse_dropdown" },
    ];

    const WAREHOUSE_OPTIONS = JSON.parse('{{ warehouse_json|escapejs }}');

    let filterRowCount = 0;
    const maxFilterRows = 9;
    let suppressAutoAdd = false;
    let lastRowManuallyCreated = false;

    function getSelectedFilterValues() {
      const selected = [];
      document.querySelectorAll('.filter-select').forEach(sel => {
        if (sel.value !== "no_condition") selected.push(sel.value);
      });
      return selected;
    }

    function areAllFiltersUsed() {
      const used = getSelectedFilterValues();
      return ALL_FILTER_OPTIONS.filter(o => o.value !== "no_condition")
                               .every(o => used.includes(o.value));
    }

    function updateAvailableFilters() {
      const selected = getSelectedFilterValues();
      document.querySelectorAll('.filter-select').forEach(sel => {
        const curVal = sel.value;
        sel.innerHTML = "";
        ALL_FILTER_OPTIONS.forEach(opt => {
          if (opt.value === "no_condition" || opt.value === curVal || !selected.includes(opt.value)) {
            const o = document.createElement("option");
            o.value = opt.value;
            o.textContent = opt.text;
            sel.appendChild(o);
          }
        });
        sel.value = curVal;
      });
    }

    function updateFilterRow(select) {
      const row = select.closest(".filter-row");
      const type = select.value;
      const input = row.querySelector(".input-container");
      input.innerHTML = "";
      const opt = ALL_FILTER_OPTIONS.find(o => o.value === type);
      const idx = row.dataset.filterIndex;

      if (opt && opt.type === "text") {
        input.innerHTML = `<input type="text" name="filter_value_${idx}" class="form-control" placeholder="${opt.text}">`;
      } else if (opt && opt.type === "warehouse_dropdown") {
        let opts = `<option value="">Select ${opt.text}</option>`;
        WAREHOUSE_OPTIONS.forEach(w => { opts += `<option value="${w}">${w}</option>`; });
        input.innerHTML = `<select name="filter_value_${idx}" class="form-select">${opts}</select>`;
      }

      updateAvailableFilters();

      const lastRow = document.querySelector(".filter-row:last-child");
      const prevVal = select.dataset.prevValue ?? "no_condition";
      const allUsed = areAllFiltersUsed();

      if (
        !suppressAutoAdd &&
        lastRow === row &&
        type !== "no_condition" &&
        prevVal === "no_condition" &&
        filterRowCount < maxFilterRows &&
        !allUsed
      ) {
        addFilterRow();
      }

      select.dataset.prevValue = type;
      updateAddRemoveButtonVisibility();
    }

    function addFilterRow(initial = "no_condition", val = "") {
      if (filterRowCount >= maxFilterRows) return;
      filterRowCount++;
      const idx = filterRowCount;
      const cont = document.getElementById("filterRowsContainer");

      const row = document.createElement("div");
      row.classList.add("row", "g-3", "mb-3", "filter-row");
      row.dataset.filterIndex = idx;
      row.innerHTML = `
        <div class="col-md-4">
          <select name="filter_type_${idx}" class="form-select filter-select"></select>
        </div>
        <div class="col-md-6 input-container"></div>
        <div class="col-md-2 d-flex justify-content-end">
          <button type="button" class="btn btn-danger remove-filter-row me-1" onclick="removeFilterRow(this)">
            <i class="fa fa-times"></i>
          </button>
          <button type="button" class="btn btn-info add-filter-row-btn" style="display:none;">
            <i class="fa fa-plus"></i> Add
          </button>
        </div>
      `;
      cont.appendChild(row);

      const select = row.querySelector(".filter-select");
      updateAvailableFilters();
      select.value = initial;
      select.addEventListener("focus", () => select.dataset.prevValue = select.value);
      select.addEventListener("pointerdown", () => select.dataset.prevValue = select.value);
      select.addEventListener("change", () => updateFilterRow(select));
      updateFilterRow(select);

      if (val) {
        const input = row.querySelector(`[name="filter_value_${idx}"]`);
        if (input) input.value = val;
      }

      row.querySelector(".add-filter-row-btn").addEventListener("click", () => addFilterRow());
      updateAddRemoveButtonVisibility();
    }

    function removeFilterRow(btn) {
      const row = btn.closest(".filter-row");
      const all = Array.from(document.querySelectorAll(".filter-row"));
      const isLast = all.length && all[all.length - 1] === row;
      row.remove();
      filterRowCount = document.querySelectorAll(".filter-row").length;
      lastRowManuallyCreated = isLast;
      updateAvailableFilters();
      updateAddRemoveButtonVisibility();
    }

    function updateAddRemoveButtonVisibility() {
      const rows = document.querySelectorAll(".filter-row");
      rows.forEach((row, i) => {
        const rm = row.querySelector(".remove-filter-row");
        const add = row.querySelector(".add-filter-row-btn");
        const sel = row.querySelector(".filter-select");

        rm.style.display = (rows.length > 1) ? "inline-block" : "none";
        add.style.display = "none";

        if (i === rows.length - 1) {
            const allUsed = areAllFiltersUsed();
            if (allUsed) {
                add.style.display = "none";
            } else {
                if (lastRowManuallyCreated) {
                    add.style.display = (filterRowCount < maxFilterRows) ? "inline-block" : "none";
                } else if (sel.value === "no_condition" && filterRowCount < maxFilterRows) {
                    add.style.display = "inline-block";
                }
            }
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      suppressAutoAdd = true;
      const urlParams = new URLSearchParams(window.location.search);
      const existing = [];
      for (let i = 1; i <= maxFilterRows; i++) {
        const ft = urlParams.get(`filter_type_${i}`);
        const fv = urlParams.get(`filter_value_${i}`);
        if (ft && ft !== "no_condition") existing.push({ type: ft, value: fv || "" });
      }

      if (existing.length) {
        existing.forEach(f => addFilterRow(f.type, f.value));
        if (filterRowCount < maxFilterRows) addFilterRow();
      } else {
        addFilterRow();
      }

      document.querySelectorAll(".filter-select").forEach(sel => sel.dataset.prevValue = sel.value);
      suppressAutoAdd = false;
      updateAddRemoveButtonVisibility();
      updateAvailableFilters();
    });
</script>
{% endblock %}
