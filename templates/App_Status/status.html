{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load status_custom_filters %}

{% block title_block %} Status {% endblock %}

{% block body_block %}
<a href="{% url 'App_Home:home_page' %}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Back
</a>
<center><h1><b> Status </b></h1></center>
<div class="container mt-4">
    <h2>Search Items</h2>

    <form method="GET" action="{% url 'App_Status:status_page' %}" class="row g-3" id="searchForm">
        <div id="filter-container">
            <!-- Filter rows will be added here by JavaScript -->
        </div>
        <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary me-3">Search</button>
            <button type="button" class="btn btn-secondary" onclick="printResults()">Print</button>
        </div>
    </form>

    <h4>Search Results</h4>

    <div id="printableArea" class="table-responsive">
        <h3 class="text-center">Status</h3>
        <br>
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Package ID</th>
                    <th>Item Name</th>
                    <th>Warehouse</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Entry/Update date <center>yyyy-mm-dd</center></th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                    <tr>
                        <td>{{ item.package.packageId }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.warehouse }}</td>
                        <td>{{ item.unit_of_item }}</td>
                        <td>{{ item.quantity_of_item }}</td>
                        <td>{{ item.created_at | date:"Y-m-d" }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-danger">No matching data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<style>
    /* Improve table readability */
    .table {
        font-size: 14px;
        text-align: center;
    }

    /* Fixed table header */
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1020;
    }

    /* Make table header stand out */
    .table-dark th {
        background-color: #343a40 !important;
        color: white !important;
    }

    /* Improve spacing and border visibility */
    .table-bordered th, .table-bordered td {
        border: 1px solid #ddd !important;
        padding: 10px;
    }

    /* Hover effect for better interaction */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Hide unnecessary elements when printing */
    @media print {
        body * {
            visibility: hidden;
        }
        #printableArea, #printableArea * {
            visibility: visible;
        }
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }

        /* Add margins to the printed page */
        @page {
            size: A4;
            margin: 0.5in;
        }

        /* Hide the page title and URL */
        @media print {
            @page {
                margin: 0.5in;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            h1, h2 {
                display: none;
            }
        }
    }
</style>

<script>
    const filterOptions = [
        "No Condition",
        "Package ID",
        "Item Name",
        "Warehouse",
        "Unit",
        "Entry/Update date"
    ];

    // Helper to get option properties from its value
    function getFilterOptionProperties(value) {
        switch (value) {
            case "No Condition": return { hasInput: false };
            case "Package ID": return { hasInput: true, inputType: "text" };
            case "Item Name": return { hasInput: true, inputType: "text" };
            case "Warehouse": return { hasInput: true, inputType: "text" };
            case "Unit": return { hasInput: true, inputType: "select" }; // Changed to 'select'
            case "Entry/Update date": return { hasInput: true, inputType: "date" };
            default: return { hasInput: false };
        }
    }

    let activeFilterRowCount = 0;
    const maxFilterRows = 5; // Maximum 5 filter rows with input fields

    function createFilterRow(index, initialFilterBy = "No Condition", initialQuery = "") {
        const filterContainer = document.getElementById("filter-container");
        const rowId = `filter-row-${index}`;

        const rowDiv = document.createElement("div");
        rowDiv.className = "row g-3 mb-2 align-items-center";
        rowDiv.id = rowId;

        const inputFieldHtml = (initialFilterBy === "Unit") ?
            `<select name="query_${index}" id="searchQuery_${index}" class="form-select search-query">
                <option value="">Select Unit</option>
                {% for unit in unique_units %}
                    <option value="{{ unit }}" {% if unit == initialQuery %}selected{% endif %}>{{ unit }}</option>
                {% endfor %}
            </select>` :
            `<input type="text" name="query_${index}" id="searchQuery_${index}" class="form-control search-query" placeholder="Search..." value="${initialQuery}">`;

        rowDiv.innerHTML = `
            <div class="col-md-5">
                <select name="filter_by_${index}" id="filterDropdown_${index}" class="form-select filter-dropdown">
                </select>
            </div>
            <div class="col-md-5">
                ${inputFieldHtml}
            </div>
            <div class="col-md-2 d-flex justify-content-end">
                <button type="button" class="btn btn-danger remove-filter-btn me-1" data-index="${index}" style="display: none;">
                    <i class="fa fa-times"></i>
                </button>
                <button type="button" class="btn btn-info add-filter-btn" data-index="${index}" style="display: none;">
                    <i class="fa fa-plus"></i> Add
                </button>
            </div>
        `;
        filterContainer.appendChild(rowDiv);
        activeFilterRowCount++; // Increment active count

        const dropdown = document.getElementById(`filterDropdown_${index}`);
        if (!dropdown) {
            console.error(`Dropdown element with ID filterDropdown_${index} not found.`);
            return; // Exit if dropdown not found
        }
        const inputField = document.getElementById(`searchQuery_${index}`); // This will now be the select or input
        const removeBtn = rowDiv.querySelector(".remove-filter-btn");
        const addBtn = rowDiv.querySelector(".add-filter-btn"); // Get the new add button

        // Populate dropdown options
        updateDropdownOptions(dropdown, index);

        // Set initial selected value
        dropdown.value = initialFilterBy;

        // Handle initial input field visibility and type
        const selectedOptionProps = getFilterOptionProperties(initialFilterBy);
        if (selectedOptionProps.hasInput) {
            inputField.style.display = "block";
            if (selectedOptionProps.inputType !== "select") { // Only set type if not a select
                inputField.type = selectedOptionProps.inputType;
            }
        } else {
            inputField.style.display = "none";
        }

        // Event listener for dropdown change
        dropdown.addEventListener("change", function() {
            const selectedOptionProps = getFilterOptionProperties(this.value);
            const currentInputField = document.getElementById(`searchQuery_${index}`); // Get current input field
            const previousValue = currentInputField ? currentInputField.value : ""; // Store previous value

            // Recreate input field based on new selection
            let newInputFieldHtml;
            if (this.value === "Unit") {
                newInputFieldHtml = `<select name="query_${index}" id="searchQuery_${index}" class="form-select search-query">
                    <option value="">Select Unit</option>
                    {% for unit in unique_units %}
                        <option value="{{ unit }}">{{ unit }}</option>
                    {% endfor %}
                </select>`;
            } else if (selectedOptionProps.hasInput) {
                newInputFieldHtml = `<input type="${selectedOptionProps.inputType}" name="query_${index}" id="searchQuery_${index}" class="form-control search-query" placeholder="Search..." value="${previousValue}">`;
            } else {
                newInputFieldHtml = `<input type="hidden" name="query_${index}" id="searchQuery_${index}" class="form-control search-query">`; // Hidden input for no condition
            }

            // Replace the old input field with the new one
            currentInputField.outerHTML = newInputFieldHtml;
            const updatedInputField = document.getElementById(`searchQuery_${index}`);
            if (selectedOptionProps.hasInput) {
                updatedInputField.style.display = "block";
            } else {
                updatedInputField.style.display = "none";
            }
            // Restore previous value if applicable and handle selection for unit dropdown
            if (this.value === "Unit" && previousValue) {
                const trimmedPreviousValue = previousValue.trim();
                for (let i = 0; i < updatedInputField.options.length; i++) {
                    if (updatedInputField.options[i].value === trimmedPreviousValue) {
                        updatedInputField.options[i].selected = true;
                        break;
                    }
                }
            } else {
                updatedInputField.value = previousValue; // Restore previous value for other input types
            }

            // Update options for all subsequent dropdowns
            document.querySelectorAll('.filter-dropdown').forEach((otherDropdown, idx) => {
                updateDropdownOptions(otherDropdown, parseInt(otherDropdown.id.split('_')[1]));
            });

            // Show next filter row if a condition is selected and not maxed out
            if (this.value !== "No Condition" && index === (activeFilterRowCount - 1) && activeFilterRowCount < maxFilterRows) {
                createFilterRow(activeFilterRowCount); // Use activeFilterRowCount as the new index
                document.getElementById(`filter-row-${activeFilterRowCount - 1}`).style.display = "flex"; // Display the newly created row
            } else if (this.value === "No Condition" && index < (activeFilterRowCount - 1)) {
                // If a middle dropdown is set to "No Condition", remove subsequent rows
                removeFilterRow(index + 1);
            }
            updateRemoveButtons();
            updateAddFilterButton(); // Call to update add button visibility
        });

        // Event listener for remove button
        removeBtn.addEventListener("click", function() {
            const idxToRemove = parseInt(this.dataset.index);
            removeFilterRow(idxToRemove);
            updateRemoveButtons();
            // Update options for all dropdowns after removal
            document.querySelectorAll('.filter-dropdown').forEach((otherDropdown, idx) => {
                updateDropdownOptions(otherDropdown, parseInt(otherDropdown.id.split('_')[1]));
            });
            updateAddFilterButton(); // Call to update add button visibility
        });

        // Event listener for the new add button
        addBtn.addEventListener("click", function() {
            if (activeFilterRowCount < maxFilterRows) {
                createFilterRow(activeFilterRowCount);
                document.getElementById(`filter-row-${activeFilterRowCount - 1}`).style.display = "flex";
                updateAddFilterButton();
                updateRemoveButtons();
            }
        });

        updateRemoveButtons();
        updateAddFilterButton();
    }

    function updateDropdownOptions(dropdownElement, currentIndex) {
        const selectedValues = new Set();
        // Collect all selected values from other dropdowns
        document.querySelectorAll('.filter-dropdown').forEach((otherDropdown) => {
            if (otherDropdown.id !== dropdownElement.id && otherDropdown.value !== "No Condition") {
                selectedValues.add(otherDropdown.value);
            }
        });

        const currentSelectedValue = dropdownElement.value; // Store current selection

        // Clear existing options
        dropdownElement.innerHTML = "";

        // Add "No Condition" first
        const noConditionOption = document.createElement("option");
        noConditionOption.value = "No Condition";
        noConditionOption.textContent = "No Condition";
        dropdownElement.appendChild(noConditionOption);

        // Add other options, excluding already selected ones
        filterOptions.forEach(optionValue => {
            if (optionValue !== "No Condition" && !selectedValues.has(optionValue)) {
                const opt = document.createElement("option");
                opt.value = optionValue;
                opt.textContent = optionValue; // Text content is the same as value for now
                dropdownElement.appendChild(opt);
            }
        });

        // Restore previous selection if it's still a valid option, otherwise default to "No Condition"
        if (Array.from(dropdownElement.options).some(opt => opt.value === currentSelectedValue)) {
            dropdownElement.value = currentSelectedValue;
        } else {
            dropdownElement.value = "No Condition";
        }
    }

    function removeFilterRow(startIndex) {
        for (let i = startIndex; i < activeFilterRowCount; i++) {
            const row = document.getElementById(`filter-row-${i}`);
            if (row) {
                row.remove();
            }
        }
        activeFilterRowCount = startIndex; // Set active count to the start index
        if (activeFilterRowCount < 0) activeFilterRowCount = 0; // Ensure it doesn't go below 0
        updateAddFilterButton();
        updateRemoveButtons();
    }

    function updateRemoveButtons() {
        document.querySelectorAll(".remove-filter-btn").forEach(btn => {
            btn.style.display = "none"; // Hide all by default
        });

        // Show remove button for all rows except the first one, if there's more than one active filter row
        if (activeFilterRowCount > 1) { // Only show remove buttons if there's more than one filter row
            for (let i = 1; i < activeFilterRowCount; i++) { // Start from the second row (index 1)
                const row = document.getElementById(`filter-row-${i}`);
                if (row) {
                    row.querySelector(".remove-filter-btn").style.display = "block";
                }
            }
        }
    }

    function updateAddFilterButton() {
        // Hide all add buttons first
        document.querySelectorAll(".add-filter-btn").forEach(btn => {
            btn.style.display = "none";
        });

        // Only show add button on the last active filter row if conditions are met
        if (activeFilterRowCount > 0 && activeFilterRowCount < maxFilterRows) {
            const lastRowIndex = activeFilterRowCount - 1;
            const lastDropdown = document.getElementById(`filterDropdown_${lastRowIndex}`);
            const lastAddBtn = document.getElementById(`filter-row-${lastRowIndex}`).querySelector(".add-filter-btn");

            if (lastDropdown && lastDropdown.value !== "No Condition" && lastAddBtn) {
                lastAddBtn.style.display = "block";
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Initialize the first filter row
        createFilterRow(0, "{{ filter_by_0|default:'No Condition' }}", "{{ query_0|default:'' }}");

        // Re-create rows based on existing query parameters if page reloads with filters
        let initialActiveRows = 0;
        {% for i in "1234" %} {# Loop for up to 4 additional filters #}
            {% with filter_by_key="filter_by_"|add:i|stringformat:"s" query_key="query_"|add:i|stringformat:"s" %}
                {% if request.GET|get_item:filter_by_key %}
                    createFilterRow({{ i }}, "{{ request.GET|get_item:filter_by_key }}", "{{ request.GET|get_item:query_key }}");
                    document.getElementById(`filter-row-{{ i }}`).style.display = "flex";
                    initialActiveRows = {{ i }} + 1;
                {% endif %}
            {% endwith %}
        {% endfor %}

        // Ensure activeFilterRowCount reflects the number of rows created during initialization
        activeFilterRowCount = initialActiveRows > 0 ? initialActiveRows : 1; // At least one row is always active

        // If the first row is "No Condition" and no other filters, hide add button
        const firstDropdown = document.getElementById(`filterDropdown_0`);
        if (firstDropdown && firstDropdown.value === "No Condition" && activeFilterRowCount === 1) {
            // No need to hide add button here, updateAddFilterButton handles it
        }

        updateRemoveButtons();
        updateAddFilterButton();
    });

    function printResults() {
        window.print();
    }
</script>
{% endblock %}
